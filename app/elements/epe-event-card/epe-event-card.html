<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-event-card">
  <style>
    :host {
      display: block;
      width: 100%;
    }

    h4 {
      font-size: 1.1em;
      margin: 1.5em 0 0.1em;
    }

    .event-card.event-card__detail--show {
      padding: 0 0 28px;
    }

    .event-card__header {
      background-color: var(--paper-deep-orange-700);
      color: var(--text-primary-color);
      font-size: 1.3em;
      line-height: 1;
      padding: 4px 20px;
    }

    .event-card__detail {
      background-color: var(--primary-background-color);
      color: var(--primary-text-color);
      overflow-y: scroll;
      height: 0px;
    }

    .event-card.event-card__detail--show .event-card__detail {
      display: block;
      padding: 16px 20px;
      height: 300px;
    }

    .event-card__detail .expand-less {
      display: none;
    }

    .event-card.event-card__detail--show .event-card__detail .expand-less {
      display: block;
    }

    .event-card__event-detail-name {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 16px;
    }

    .event-card__name {
      color: var(--paper-deep-orange-700);
      cursor: pointer;
      margin: 0 0 0.1em 0;
      font-size: 1.1em;
      text-decoration: underline;
    }

    .event-card__name:hover {
      text-decoration: none;
    }

    .event-card__description {
      margin: 0 0 0.5em;
    }

    .expand-less {
      position: absolute;
      bottom: 0;
      right: 0;
    }
  </style>
  <template>
    <div class="event-card" id="EventCard">

      <!-- Header toolbar for event card -->
      <div class="event-card__header layout horizontal center">

        <div class="flex">
          <span>[[eventData.eventName]]</span>
        </div>

        <paper-icon-button
          id="EventDetail"
          icon="info"
          on-tap="showDetail"></paper-icon-button>

        <paper-icon-button
          id="RelatedEvents"
          icon="social:public"
          on-tap="showDetail"
          hidden$="[[!eventData.relatedEvents.length]]"></paper-icon-button>

        <paper-icon-button
          id="RelatedPeople"
          icon="social:group"
          on-tap="showDetail"
          hidden$="[[hidePeopleIcon]]"></paper-icon-button>

        <paper-icon-button
          id="RelatedSources"
          icon="description"
          on-tap="showDetail"
          hidden$="[[!eventData.supportingEvidence.length]]"></paper-icon-button>

        <!-- paper-icon-buttons have an inherent padding that will push the tooltip down.
        offset undoes it -->
        <paper-tooltip for="EventDetail" offset="0">More information</paper-tooltip>
        <paper-tooltip for="RelatedEvents" offset="0">Related Events</paper-tooltip>
        <paper-tooltip for="RelatedPeople" offset="0">Related People</paper-tooltip>
        <paper-tooltip for="RelatedSources" offset="0">Supporting Evidence</paper-tooltip>
      </div>

      <!-- Container for event card detail Panels -->
      <div id="EventCardDetail" class="event-card__detail">
        <neon-animated-pages id="CardAnimatedPages"
                             class="relative"
                             selected="[[cardViewSelected]]"
                             entry-animation="[[slideEntryAnimation]]"
                             exit-animation="[[slideExitAnimation]]">

          <!-- Event Detail -->
          <neon-animatable>
            <div class="event-card__event-detail">
              <h3 class="event-card__event-detail-name">
                <span>[[eventData.eventName]]</span>
              </h3>
              <div class="event-card__event-detail-description">
                <span>[[eventData.eventDescription]]</span>
              </div>
            </div>
          </neon-animatable>

          <!-- Related Events -->
          <neon-animatable>
            <div class="event-card__related-events">
              <h3 class="event-card__related-events-name">
                <span>Related Events</span>
              </h3>
              <div class="event-card__related-events">
                <template is="dom-repeat"
                          items="[[eventData.relatedEvents]]">
                  <div class="event-card__name"
                    on-tap="navigateToEvent">[[item.name]]</div>
                  <div class="event-card__description">[[item.description]]</div>
                </template>
              </div>
            </div>
          </neon-animatable>

          <!-- Related People -->
          <neon-animatable>
            <div class="event-card__related-people">
              <h3 class="event-card__related-people-name">
                <span>Related People</span>
              </h3>
              <div class="event-card__related-people-description">
                <div class="event-card__witnesses"
                  hidden$="[[!eventData.relatedPeople.suspects.length]]">
                  <h4>Suspects</h4>

                  <template is="dom-repeat"
                            items="[[eventData.relatedPeople.suspects]]">
                    <div class="event-card__name"
                         on-tap="navigateToEvent">[[item.name]]</div>
                    <!--<div class="event-card__description">[[item.description]]</div>-->
                  </template>
                </div>
                <div class="event-card__witnesses"
                     hidden$="[[!eventData.relatedPeople.victims.length]]">
                  <h4>Victims</h4>

                  <template is="dom-repeat"
                            items="[[eventData.relatedPeople.victims]]">
                    <div class="event-card__name"
                         on-tap="navigateToEvent">[[item.name]]</div>
                    <!--<div class="event-card__description">[[item.description]]</div>-->
                  </template>
                </div>
                <div class="event-card__witnesses"
                     hidden$="[[!eventData.relatedPeople.witnesses.length]]">
                  <h4>Witnesses</h4>

                  <template is="dom-repeat"
                            items="[[eventData.relatedPeople.witnesses]]">
                    <div class="event-card__name"
                         on-tap="navigateToEvent">[[item.name]]</div>
                    <!--<div class="event-card__description">[[item.description]]</div>-->
                  </template>
                </div>
              </div>
            </div>
          </neon-animatable>

          <!-- Related Places -->
          <neon-animatable>
            <div class="event-card__related-sources">
              <h3 class="event-card__related-sources-name">
                <span>Supporting Evidence</span>
              </h3>
              <div class="event-card__related-sources-description">
                <span>List of related sources</span>
              </div>
            </div>
          </neon-animatable>
        </neon-animated-pages>

        <!-- Expand Less button -->
        <paper-icon-button
          id="ExpandLess"
          class="expand-less"
          icon="expand-less"
          on-tap="hideDetail"></paper-icon-button>
      </div>

    </div>

  </template>
</dom-module>
<script>
(function() {
  Polymer({

    is: 'epe-event-card',

    properties: {

      eventData: {
        type: String,
        observer: 'eventDataChanged'
      },

      hidePeopleIcon: {
        type: Boolean,
        value: true
      },

      cardExpanded: {
        type: Boolean,
        value: false
      },

      map: {
        type: Object
      },

      cardViewSelected: {
        type: Number,
        value: 0
      },

      slideEntryAnimation: {
        type: String,
        value: 'slide-from-right-animation'
      },

      slideExitAnimation: {
        type: String,
        value: 'slide-left-animation'
      }
    },

    ready: function() {

      // Deserialise Stringified eventData Object
      this.eventData = JSON.parse(this.eventData);

      // Set map
      this.map = this.closest('#LeafletMap').map;

      this.map.on('zoomend', function() {
        if (this.cardExpanded) {
          this.async(this.setExpandedOffset);
        }
      }.bind(this));
    },

    // Set offset for and expanded card
    setExpandedOffset: function() {

      var $popUp = this.closest('.leaflet-popup');

      if ($popUp) {
        $popUp.style.bottom = '-356px';
      }
    },

    // Set offset for and unexpanded card
    setUnExpandedOffset: function() {

      var $popUp = this.closest('.leaflet-popup');

      if ($popUp) {
        $popUp.style.bottom = '4px';
      }
    },

    // Show hidden detail panel
    showDetail: function(event) {

      var $detailContainer = this.$.EventCard;

      // If card is already expanded, show the relevant pane
      if (this.cardExpanded) {
        this.selectPanel(event.currentTarget.id);
      } else {

        this.setExpandedOffset();

        $detailContainer.classList.add('event-card__detail--show');

        this.cardExpanded = true;

        // Show relevant panel
        this.selectPanel(event.currentTarget.id);
      }
    },

    // Hide detail panel
    hideDetail: function() {

      this.cardExpanded = false;

      this.setUnExpandedOffset();

      this.$.EventCard.classList.remove('event-card__detail--show');
    },

    // Select the relevant panel
    selectPanel: function(panelType) {

      switch(panelType) {
        case 'EventDetail':
          // Set animation to slide correct way
          this.slideEntryAnimation = 'slide-from-left-animation';
          this.slideExitAnimation = 'slide-right-animation';

          this.cardViewSelected = 0;
          break;
        case 'RelatedEvents':
          // Set animation to slide correct way
          if (this.cardViewSelected > 1) {
            this.slideEntryAnimation = 'slide-from-left-animation';
            this.slideExitAnimation = 'slide-right-animation';
          } else {
            this.slideEntryAnimation = 'slide-from-right-animation';
            this.slideExitAnimation = 'slide-left-animation';
          }

          this.cardViewSelected = 1;
          break;
        case 'RelatedPeople':
          // Set animation to slide correct way
          if (this.cardViewSelected > 2) {
            this.slideEntryAnimation = 'slide-from-left-animation';
            this.slideExitAnimation = 'slide-right-animation';
          } else {
            this.slideEntryAnimation = 'slide-from-right-animation';
            this.slideExitAnimation = 'slide-left-animation';
          }

          this.cardViewSelected = 2;
          break;
        case 'RelatedSources':
          this.slideEntryAnimation = 'slide-from-right-animation';
          this.slideExitAnimation = 'slide-left-animation';

          this.cardViewSelected = 3;
          break;
        default:
          this.cardViewSelected = 0;
      }
    },

    // FIRED BY USER TAPPING A RELATED EVENT
    navigateToEvent: function(event) {

      var eventToJumpToID = event.model.item.id;
      var $map = this.closest('#LeafletMap');
      var mapMarkers = $map.querySelector('#MapGeoJSON').markers;

      // Maybe because the element is created through an ECMAScript6 template, the event bubbles up to
      // paper-panel-drawer and throws an error. Stop propagation as not needed anyway.
      event.stopPropagation();

      mapMarkers.forEach(function(marker) {

        // If marker to jump to exists as marker on the map
        if (eventToJumpToID === marker.feature.properties.id) {

          // Pan to marker
          $map.map.setView(marker.getLatLng());

          // Open marker popup
          marker.openPopup();
        }
      });

      // ToDo: Add functionality to handle places not on the map
    },

    // CALLED BY OBSERVABLE ON EVENTDATA
    eventDataChanged: function() {

      // Needs this check as the eventData is passed into this element at first as a string by the ECMAScript6 template
      if (typeof this.eventData === 'object') {

        if (this.eventData.relatedPeople.suspects.length || this.eventData.relatedPeople.victims.length || this.eventData.relatedPeople.witnesses.length) {
          this.hidePeopleIcon = false;
        } else {
          this.hidePeopleIcon = true;
        }
      }
    }
  });
})();
</script>
