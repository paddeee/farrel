<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-map">
  <link rel="stylesheet" href="../../styles/vendor/leaflet/leaflet-draw.css" />
  <link rel="stylesheet" href="../../styles/vendor/leaflet/leaflet-style-editor.css" />
  <style>

    :host {
      display: block;
    }

    leaflet-map {
      height: 100%;
    }

    leaflet-map /deep/ .leaflet-top {
      z-index: 0;
    }

    leaflet-map /deep/ .leaflet-control-attribution.leaflet-control {
      display: none;
    }

    leaflet-map /deep/ .leaflet-container a.leaflet-popup-close-button {
      color: var(--text-primary-color);
    }

    leaflet-map /deep/ .leaflet-container a.leaflet-popup-close-button:hover {
      color: var(--accent-color);
    }

    leaflet-map /deep/ .leaflet-popup-content-wrapper {
      border-radius: 0;
      padding: 0;
    }

    leaflet-map /deep/ .leaflet-popup-content {
      margin: 0;
    }

    leaflet-map /deep/ .leaflet-popup-tip-container {
      position: absolute;
      left: -30px;
      top: 16px;
      transform: rotate(90deg);
    }

    leaflet-map /deep/ .leaflet-popup-tip {
      background-color: var(--paper-deep-orange-700);
      color: var(--text-primary-color);
    }

  </style>
  <script src="../../scripts/vendor/leaflet/leaflet-draw.js"></script>
  <script src="../../scripts/vendor/leaflet/leaflet-style-forms.js"></script>
  <script src="../../scripts/vendor/leaflet/leaflet-style-editor.js"></script>
  <template>

    <leaflet-map id="LeafletMap"
                 latitude="40.20824570152502"
                 longitude="21.37939453125"
                 zoom="7"
                 min-zoom="7"
                 max-zoom="19"
                 maxBounds="[[maxBounds]]"
                 fitToMarkers
                 on-load="mapReady">

      <leaflet-tilelayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png">
      </leaflet-tilelayer>

      <epe-map-geojson id="MapGeoJSON"
                       data="[[geoJSON]]">
      </epe-map-geojson>
    </leaflet-map>

  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: 'epe-map',

    properties: {

      // Remember state so draw controls are only added once
      drawFunctionalityAdded: {
        type: Boolean,
        value: false
      },

      geoJSON:  {
        type: Object
      }
    },

    ready: function() {

      if (this.mapGeoJsonStore) {

        // When the events data is updated, update our grid data
        this.mapGeoJsonStore.listen(function(mapGeoJsonStore) {

          this.geoJSON = mapGeoJsonStore.geoJSONObject;

        }.bind(this));
      }

    },

    // CALLED FROM LEAFLET MAP LOAD EVENT FIRING
    mapReady: function() {

      // Set up Leaflet Draw
      this.setUpLeafletDraw();

      // Set the max bounds
      this.setMaxBounds();
    },

    // Set the bounds limitations
    // ToDO: Set bounds based off supplied coordinates
    setMaxBounds: function() {

      // Need this as mapReady is called several times. I would have expected leaflet map's load event to only fire once
      // but it doesn't.
      if (this.$.LeafletMap.map.maxBounds) {
        return;
      }

      var southWest = {
        lat: 36.66841891894786,
        lng: 16.226806640625
      };
      var northEast = {
        lat: 43.572431747409745,
        lng: 26.531982421874996
      };

      this.$.LeafletMap.map.setMaxBounds(window.L.latLngBounds(southWest, northEast));
    },

    // Leaflet seems to need a kick to resize tiles when navigating to and from a map view
    resizeMap: function() {
      this.$.LeafletMap.fire('resize');
    },

    // Set up the annotation functionality
    setUpLeafletDraw: function() {

      var drawnItems;
      var styleEditor;

      if (this.drawFunctionalityAdded) {
        return;
      }

      //Initialize the StyleEditor
      styleEditor = window.L.control.styleEditor({
        position: 'topleft',
        openOnLeafletDraw: false,
        showTooltip: false,
        useGrouping: false
      });

      this.$.LeafletMap.map.addControl(styleEditor);

      drawnItems = new window.L.FeatureGroup();

      this.$.LeafletMap.map.addLayer(drawnItems);

      var drawControl = new window.L.Control.Draw({
        draw: {
          position: 'topleft',
          polygon: {
            title: 'Draw a polygon',
            allowIntersection: false,
            drawError: {
              color: '#b00b00',
              timeout: 1000
            },
            shapeOptions: {
              color: '#bada55'
            },
            showArea: true
          },
          polyline: {
            metric: false
          },
          circle: {
            shapeOptions: {
              color: '#662d91'
            }
          }
        },
        edit: {
          featureGroup: drawnItems
        }
      });

      this.$.LeafletMap.map.addControl(drawControl);

      this.$.LeafletMap.map.on('draw:created', function(e) {
        //var type = e.layerType;
        var layer = e.layer;

        /*if (type === 'marker') {
          layer.bindPopup('A popup!');
        }*/

        drawnItems.addLayer(layer);
      });

      this.$.LeafletMap.map.on('styleeditor:changed', function(element) {
        console.log(element);
      });

      this.drawFunctionalityAdded = true;
    }
  });
})();
</script>
