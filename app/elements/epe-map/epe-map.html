<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-map">
  <link rel="stylesheet" href="../../styles/vendor/leaflet/leaflet-draw.css" />
  <link rel="stylesheet" href="../../styles/vendor/leaflet/leaflet-style-editor.css" />
  <style>

    :host {
      display: block;
    }

    leaflet-map {
      height: 100%;
    }

    leaflet-map .leaflet-top {
      z-index: 0;
    }

    .leaflet-marker-pane,
    .leaflet-popup-pane {
      opacity: 0.85;
    }

    .leaflet-popup .event-card__header,
    .leaflet-popup-tip {
      background-color: var(--paper-deep-orange-700);
      color: var(--text-primary-color);
    }

    :host .leaflet-popup.point-of-interest .event-card__header,
    .leaflet-popup.point-of-interest .leaflet-popup-tip {
      background-color: rgb(47, 47, 47);
    }

    :host .leaflet-popup.arson .event-card__header,
    .leaflet-popup.arson .leaflet-popup-tip {
      background-color: rgb(246, 151, 48);
    }

    :host .leaflet-popup.kidnapping .event-card__header,
    .leaflet-popup.kidnapping .leaflet-popup-tip {
      background-color: rgb(210, 82, 185);
    }

    :host .leaflet-popup.murder .event-card__header,
    .leaflet-popup.murder .leaflet-popup-tip {
      background-color: rgb(214, 62, 42);
    }

    .leaflet-control-attribution.leaflet-control {
      display: none;
    }

    .leaflet-container a.leaflet-popup-close-button {
      color: var(--text-primary-color);
    }

    .leaflet-container a.leaflet-popup-close-button:hover {
      color: var(--accent-color);
    }

    .leaflet-popup-content-wrapper {
      border-radius: 0;
      padding: 0;
    }

    .leaflet-popup-content {
      margin: 0;
    }

    .leaflet-popup-tip-container {
      position: absolute;
      left: -30px;
      top: 16px;
      transform: rotate(90deg);
    }

    .leaflet-bar a,
    .leaflet-bar a:hover {
      width: 29px;
      height: 29px;
      line-height: 29px;
    }

    .timeline-control-holder {
      background-color: var(--primary-background-color);
      position: fixed;
      bottom: 10px;
      -webkit-transition-property: -webkit-transform, width;
      transition-property: transform, width;
      -webkit-transition-duration: 300ms;
      transition-duration: 300ms;
      -webkit-transition-timing-function: ease-in-out;
      transition-timing-function: ease-in-out;
      -ms-transform: translateX(0px);
      -webkit-transform: translateX(0px);
      transform: translateX(0px);
    }

    .timeline-control-previous {
      height: 29px;
      width: 29px;
      left: 10px;
    }

    .timeline-control-next {
      height: 29px;
      width: 29px;
      right: 10px;
    }

    .timeline-control-previous--hide,
    .timeline-control-previous.timeline--showing {
      -ms-transform: translateX(-100vw);
      -webkit-transform: translateX(-100vw);
      transform: translateX(-100vw);
    }

    .timeline-control-next--hide,
    .timeline-control-next.timeline--showing {
      -ms-transform: translateX(100vw);
      -webkit-transform: translateX(100vw);
      transform: translateX(100vw);
    }

    .timeline-control-section {
      height: 29px;
      width: 60px;
      left: calc(50% - 30px);
    }

    .timeline-control-section.timeline--showing {
      -webkit-transition-duration: 300ms;
      transition-duration: 300ms;
      -webkit-transition-timing-function: ease-in-out;
      transition-timing-function: ease-in-out;
      -ms-transform: translateY(-216px);
      -webkit-transform: translateY(-216px);
      transform: translateY(-216px);
    }

    .timeline-control-section--hide {
      -ms-transform: translateX(-100vw);
      -webkit-transform: translateX(-100vw);
      transform: translateX(-100vw);
    }

    .timeline-control {
      cursor: pointer;
      height: 29px;
      width: 29px;
    }

    .timeline-control--disabled {
      cursor: default;
      background-color: rgb(244, 244, 244);
      color: rgb(187, 187, 187);
    }

    .timeline-control-section:hover,
    .timeline-control-previous:hover,
    .timeline-control-next:hover {
      background-color: var(--map-control-hover-colour);
    }

    .timeline {
      bottom: 0;
      width: 100%;
      background-color: transparent;
      height: 215px;
      position: fixed;
      overflow: hidden;
      -webkit-transition-duration: 300ms;
      transition-duration: 300ms;
      -webkit-transition-timing-function: ease-in-out;
      transition-timing-function: ease-in-out;
      -ms-transform: translateY(240px);
      -webkit-transform: translateY(240px);
      transform: translateY(240px);
      z-index: 2;
    }

    .timeline.timeline--showing {
      -ms-transform: translateY(0);
      -webkit-transform: translateY(0);
      transform: translateY(0);
    }

    epe-timeline {
      background-color: var(--primary-background-color);
      display: block;
      margin: 0;
      box-shadow: 0 1px 7px rgba(0, 0, 0, 0.65);
    }

    .event-card-no-location {
      box-shadow: rgba(0, 0, 0, 0.4) 0px 3px 14px;
      font-size: 12px;
      position: fixed;
      left: calc(50% - 200px);
      top: 80px;
      width: 400px;
      -webkit-transition-duration: 600ms;
      transition-duration: 600ms;
      -webkit-transition-timing-function: ease-in-out;
      transition-timing-function: ease-in-out;
      -ms-transform: translateY(-600px);
      -webkit-transform: translateY(-600px);
      transform: translateY(-600px);
      opacity: 0.85;
    }

    .event-card-no-location.event-card--showing {
      -ms-transform: translateY(0);
      -webkit-transform: translateY(0);
      transform: translateY(0);
    }

    .event-card-no-location. event-card__detail--show .event-card__detail {
      height: 250px;
      position: relative;
    }

    .event-card-no-location .event-card__detail--show {
      padding: 0;
    }

    epe-timeline {
      opacity: 0.85;
    }

    .timeline-tooltip {
      -ms-transform: translateY(128px);
      -webkit-transform: translateY(128px);
      transform: translateY(128px);
    }

  </style>
  <script src="../../scripts/vendor/leaflet/leaflet-draw.js"></script>
  <script src="../../scripts/vendor/leaflet/leaflet-style-forms.js"></script>
  <script src="../../scripts/vendor/leaflet/leaflet-style-editor.js"></script>
  <template>

    <leaflet-map id="LeafletMap"
                 latitude="40.20824570152502"
                 longitude="21.37939453125"
                 zoom="7"
                 min-zoom="7"
                 max-zoom="18"
                 maxBounds="[[maxBounds]]"
                 fitToMarkers
                 on-load="mapReady">

      <leaflet-tilelayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png">
      </leaflet-tilelayer>

      <epe-map-geojson id="MapGeoJSON"
                       data="[[geoJSON]]"
                       navigating-events="[[navigatingEvents]]"
                       selected-records-actions="[[selectedRecordsActions]]"
                       active-event="[[activeEvent]]"
                       active-place="[[activePlace]]"
                       on-toggle-event-card-no-location="toggleEventCardNoLocation">
      </epe-map-geojson>

      <!-- Event Card for events with no location -->
      <epe-event-card id="EventCard"
                      class="event-card-no-location"
                      event-data="[[activeEventData]]"></epe-event-card>

    </leaflet-map>

    <!-- Navigate Previous control -->
    <paper-material id="NavigatePreviousControl"
                    class="timeline-control-holder timeline-control-previous timeline-control-previous--hide layout horizontal">
      <div class="timeline-control timeline-control--disabled layout horizontal center center-justified"
           on-tap="goToPrevious">
        <iron-icon class="toggle-timeline"
                   icon="arrow-back"></iron-icon>
      </div>
    </paper-material>

    <!-- Navigate Next control -->
    <paper-material id="NavigateNextControl"
                    class="timeline-control-holder timeline-control-next timeline-control-next--hide layout horizontal">
      <div class="timeline-control timeline-control--disabled layout horizontal center center-justified"
           on-tap="goToNext">
        <iron-icon id="NextButton"
                   class="toggle-timeline"
                   icon="arrow-forward"></iron-icon>
      </div>
    </paper-material>

    <!-- TimeLine Toggle control -->
    <paper-material id="TimeLineControl"
                    class="timeline-control-holder timeline-control-section timeline-control-section--hide layout horizontal">
      <div class="timeline-control layout horizontal center center-justified">
        <iron-icon class="toggle-timeline"
                   icon="timeline"
                   on-tap="toggleTimeline"></iron-icon>
      </div>
      <div class="timeline-control timeline-toggle layout horizontal center center-justified"
           hidden$="[[timelineShowing]]">
        <iron-icon class="toggle-timeline"
                   icon="expand-less"
                   on-tap="toggleTimeline"></iron-icon>
      </div>
      <div class="timeline-control timeline-toggle layout horizontal center center-justified"
           hidden$="[[!timelineShowing]]">
        <iron-icon class="toggle-timeline"
                   icon="expand-more"
                   on-tap="toggleTimeline"></iron-icon>
      </div>
    </paper-material>
    <paper-tooltip for="TimeLineControl"
                   position="top"
                   class="timeline-tooltip">Toggle Timeline</paper-tooltip>
    <paper-tooltip for="NavigatePreviousControl"
                   position="right"
                   class="timeline-tooltip">Show Previous Event Information</paper-tooltip>
    <paper-tooltip for="NavigateNextControl"
                   position="left"
                   class="timeline-tooltip">Show Next Event Information</paper-tooltip>

    <paper-material id="TimeLine"
                    class="timeline"
                    elevation="3">

      <!-- Timeline Element -->
      <epe-timeline id="TimeLineElement"
                    time-line-store="[[timeLineStore]]"
                    selected-records-actions="[[selectedRecordsActions]]"
                    on-timeline-events-changed="toggleTimeLineEnabled"
                    on-button-state-changed="timelineButtonStateChanged"></epe-timeline>
    </paper-material>

  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: 'epe-map',

    properties: {

      navigatingEvents: {
        type: Boolean,
        value: false
      },

      // Remember state so draw controls are only added once
      drawFunctionalityAdded: {
        type: Boolean,
        value: false
      },

      geoJSON:  {
        type: Object
      },

      timelineShowing: {
        type: Boolean,
        value: false
      },

      activeEvent: {
        type: String,
        value: ''
      },

      activeEventData: {
        type: Object
      },

      noneGeoJSONObject: {
        type: Object
      }
    },

    ready: function() {

      this.scopeSubtree(this.$.LeafletMap, true);

      if (this.mapGeoJsonStore) {

        // When the events data is updated, update our grid data
        this.mapGeoJsonStore.listen(function(mapBroadcast) {

          if (mapBroadcast.message.type === 'geoJSONCreated') {
            this.navigatingEvents = false;
            this.activeEvent = mapBroadcast.activeEvent;
            this.geoJSON = mapBroadcast.geoJSONObject;
            this.noneGeoJSONObject = mapBroadcast.noneGeoJSONObject;
          } else if (mapBroadcast.message.type === 'timeLineSelectedRecord') {
            this.navigatingEvents = true;
            this.activeEvent = mapBroadcast.activeEvent;
            this.activePlace = mapBroadcast.activePlace;
          } else if (mapBroadcast.message.type === 'setToAll') {
            this.navigatingEvents = false;
            this.geoJSON = mapBroadcast.geoJSONObject;
            this.noneGeoJSONObject = mapBroadcast.noneGeoJSONObject;
            this.activeEvent = mapBroadcast.activeEvent;
            this.activePlace = mapBroadcast.activePlace;
          } else if (mapBroadcast.message.type === 'setToOneChanged') {
            this.navigatingEvents = false;
            this.geoJSON = mapBroadcast.geoJSONObject;
            this.noneGeoJSONObject = mapBroadcast.noneGeoJSONObject;
            this.activeEvent = mapBroadcast.activeEvent;
            this.activePlace = mapBroadcast.activePlace;
          } else if (mapBroadcast.message.type === 'setToPlusOneChanged') {
            this.navigatingEvents = false;
            this.geoJSON = mapBroadcast.geoJSONObject;
            this.noneGeoJSONObject = mapBroadcast.noneGeoJSONObject;
            this.activeEvent = mapBroadcast.activeEvent;
            this.activePlace = mapBroadcast.activePlace;
          }

        }.bind(this));
      }
    },

    // CALLED FROM LEAFLET MAP LOAD EVENT FIRING
    mapReady: function() {

      // Set up Leaflet Draw
      this.setUpLeafletDraw();

      // Set the max bounds
      this.setMaxBounds();
    },

    // Set the bounds limitations
    // ToDO: Set bounds based off supplied coordinates
    setMaxBounds: function() {

      // Need this as mapReady is called several times. I would have expected leaflet map's load event to only fire once
      // but it doesn't.
      if (this.$.LeafletMap.map.maxBounds) {
        return;
      }

      var southWest = {
        lat: 36.66841891894786,
        lng: 16.226806640625
      };
      var northEast = {
        lat: 43.572431747409745,
        lng: 26.531982421874996
      };

      this.$.LeafletMap.map.setMaxBounds(window.L.latLngBounds(southWest, northEast));
    },

    // Leaflet seems to need a kick to resize tiles when navigating to and from a map view
    resizeMap: function() {
      this.$.LeafletMap.fire('resize');
    },

    // TimeLine needs a kick to not position events on top of each other
    initialiseTimelineUI: function() {
      this.$.TimeLineElement.initialiseTimelineUI();
    },

    // Set up the annotation functionality
    setUpLeafletDraw: function() {

      var drawnItems;
      var styleEditor;

      if (this.drawFunctionalityAdded) {
        return;
      }

      //Initialize the StyleEditor
      styleEditor = window.L.control.styleEditor({
        position: 'topleft',
        openOnLeafletDraw: false,
        showTooltip: false,
        useGrouping: false
      });

      this.$.LeafletMap.map.addControl(styleEditor);

      drawnItems = new window.L.FeatureGroup();

      this.$.LeafletMap.map.addLayer(drawnItems);

      var drawControl = new window.L.Control.Draw({
        draw: {
          position: 'topleft',
          polygon: {
            title: 'Draw a polygon',
            allowIntersection: false,
            drawError: {
              color: '#b00b00',
              timeout: 1000
            },
            shapeOptions: {
              color: '#bada55'
            },
            showArea: true
          },
          polyline: {
            metric: false
          },
          circle: {
            shapeOptions: {
              color: '#662d91'
            }
          }
        },
        edit: {
          featureGroup: drawnItems
        }
      });

      this.$.LeafletMap.map.addControl(drawControl);

      this.$.LeafletMap.map.on('draw:created', function(e) {
        //var type = e.layerType;
        var layer = e.layer;

        /*if (type === 'marker') {
          layer.bindPopup('A popup!');
        }*/

        drawnItems.addLayer(layer);
      });

      this.$.LeafletMap.map.on('styleeditor:changed', function(element) {
        console.log(element);
      });

      this.drawFunctionalityAdded = true;
    },

    // Show/Hide Timeline
    toggleTimeline: function() {

      this.timelineShowing = !this.timelineShowing;

      if (this.timelineShowing) {
        this.$.TimeLine.classList.add('timeline--showing');
        this.$.TimeLineControl.classList.add('timeline--showing');
        this.$.NavigatePreviousControl.classList.add('timeline--showing');
        this.$.NavigateNextControl.classList.add('timeline--showing');
      } else {
        this.$.TimeLine.classList.remove('timeline--showing');
        this.$.TimeLineControl.classList.remove('timeline--showing');
        this.$.NavigatePreviousControl.classList.remove('timeline--showing');
        this.$.NavigateNextControl.classList.remove('timeline--showing');
      }
    },

    // FIRED FROM TIMELINE ELEMENT
    toggleTimeLineEnabled: function(event) {

      if (event.detail.showControls) {

        this.$.TimeLineControl.classList.remove('timeline-control-section--hide');
        this.$.NavigatePreviousControl.classList.remove('timeline-control-previous--hide');
        this.$.NavigateNextControl.classList.remove('timeline-control-next--hide');

      } else {

        this.$.TimeLine.classList.remove('timeline--showing');

        this.$.TimeLineControl.classList.remove('timeline--showing');
        this.$.TimeLineControl.classList.add('timeline-control-section--hide');

        this.$.NavigatePreviousControl.classList.remove('timeline--showing');
        this.$.NavigatePreviousControl.classList.add('timeline-control-previous--hide');

        this.$.NavigateNextControl.classList.remove('timeline--showing');
        this.$.NavigateNextControl.classList.add('timeline-control-next--hide');

        this.timelineShowing = false;
      }
    },

    // FIRED FROM EPE-MAP-GEOJSON ELEMENT
    toggleEventCardNoLocation: function(event) {

      var eventData;

      if (this.geoJSON) {

        if (event.detail.show && event.detail.activeEventId !== '0') {

          eventData = this.noneGeoJSONObject.events.filter(function(eventObject) {
            return eventObject.properties.id.toString() === event.detail.activeEventId;
          });

          if (eventData.length) {
            this.activeEventData = eventData[0].properties;
            this.$.EventCard.classList.add('event-card--showing');
          }

        } else {
          this.$.EventCard.classList.remove('event-card--showing');
        }
      }
    },

    // FIRED BY EVENT CARD CALLING THIS METHOD BY TRAVERSING UP THE DOM TREE
    viewSourceFile: function(sourceObject) {

      // Hack based around need to trigger pdf creation in pdf element so we broadcast a change to null
      // before sending out the object again.
      this.sourceActions.viewSourceFile(null);
      this.sourceActions.viewSourceFile(sourceObject);
    },

    // FIRED FROM TIMELINE ELEMENT
    timelineButtonStateChanged: function(event) {

      var $timeLinePreviousElement = this.$.NavigatePreviousControl.querySelector('.timeline-control');
      var $timeLineNextElement = this.$.NavigateNextControl.querySelector('.timeline-control');

      if (event.detail.button === 'previous') {

        if (event.detail.disabled === true) {
          $timeLinePreviousElement.classList.add('timeline-control--disabled');
        } else if (event.detail.disabled === false) {
          $timeLinePreviousElement.classList.remove('timeline-control--disabled');
        }
      } else if (event.detail.button === 'next') {

        if (event.detail.disabled === true) {
          $timeLineNextElement.classList.add('timeline-control--disabled');
        } else if (event.detail.disabled === false) {
          $timeLineNextElement.classList.remove('timeline-control--disabled');
        }
      }
    },

    // FIRED FROM NAVIGATENEXTCONTROL ELEMENT
    goToPrevious: function(event) {

      if (event.currentTarget.classList.contains('timeline-control--disabled')) {
        return;
      }

      this.$.TimeLineElement.goToPrevious();
    },

    // FIRED FROM NAVIGATENEXTCONTROL ELEMENT
    goToNext: function(event) {

      if (event.currentTarget.classList.contains('timeline-control--disabled')) {
        return;
      }

      this.$.TimeLineElement.goToNext();
    }
  });
})();
</script>
