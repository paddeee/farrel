<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-map">
  <style>

    :host {
      display: block;
    }

    leaflet-map {
      height: 100%;
    }

    leaflet-map /deep/ .leaflet-top {
      z-index: 0;
    }

    leaflet-map /deep/ .leaflet-control-attribution.leaflet-control {
      display: none;
    }

    leaflet-map /deep/ .leaflet-container a.leaflet-popup-close-button {
      color: var(--text-primary-color);
    }

    leaflet-map /deep/ .leaflet-container a.leaflet-popup-close-button:hover {
      color: var(--accent-color);
    }

    leaflet-map /deep/ .leaflet-popup-content-wrapper {
      border-radius: 0;
      padding: 0;
    }

    leaflet-map /deep/ .leaflet-popup-content {
      margin: 0;
    }

    leaflet-map /deep/ .leaflet-popup-tip-container {
      position: absolute;
      left: -30px;
      top: 16px;
      transform: rotate(90deg);
    }

    leaflet-map /deep/ .leaflet-popup-tip {
      background-color: var(--paper-deep-orange-700);
      color: var(--text-primary-color);
    }

  </style>
  <link rel="stylesheet" href="../../styles/vendor/leaflet/leaflet-draw.css" />
  <link rel="stylesheet" href="../../styles/vendor/leaflet/leaflet-style-editor.css" />
  <script src="../../scripts/vendor/leaflet/leaflet-draw.js"></script>
  <script src="../../scripts/vendor/leaflet/leaflet-style-forms.js"></script>
  <script src="../../scripts/vendor/leaflet/leaflet-style-editor.js"></script>
  <template>

    <leaflet-map id="LeafletMap"
                 latitude="40.20824570152502"
                 longitude="21.37939453125"
                 zoom="7"
                 min-zoom="7"
                 maxBounds="[[maxBounds]]"
                 fitToMarkers
                 on-load="mapReady">

      <leaflet-tilelayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" max-zoom="19">
      </leaflet-tilelayer>

      <epe-map-geojson data="[[geoJSONFeature]]">
      </epe-map-geojson>
    </leaflet-map>

  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: 'epe-map',

    properties: {

      // Remember state so draw controls are only added once
      drawFunctionalityAdded: {
        type: Boolean,
        value: false
      },

      geoJSONFeature:  {
        type: Object,
        value: {
          'type': 'FeatureCollection',
          'features': [
            {
              'type': 'Feature',
              'geometry': {
                'type': 'Point',
                'coordinates': [21.37939453125, 40.20824570152502]
              },
              'properties': {
                'eventName': 'Arson at the old vicarage',
                'eventDescription': 'Senserit repudiandae ex sea. An quod porro tamquam pro, usu at habemus efficiendi necessitatibus. Id audiam detraxit vim, detracto dissentias ne pri. Eius dissentias ad vim.',
                'placeName': 'Old Vicarage',
                'type': 'Arson',
                'relatedPeople': [
                  {
                    name: 'Barry Fadge'
                  },
                  {
                    name: 'Kevin Mintballs'
                  }
                ]
              }
            },
            {
              'type': 'Feature',
              'geometry': {
                'type': 'LineString',
                'coordinates': [
                  [21.846313476562496, 40.147637985391874],
                  [22.846313476562496, 41.147637985391874],
                  [23.846313476562496, 40.147637985391874],
                  [24.846313476562496, 41.147637985391874]
                ]
              },
              'properties': {
                'eventName': 'Murder at the murder house',
                'eventDescription': 'In sint constituam vim, has an dicta congue. Ei qui tale minim, has ornatus necessitatibus no. Ad eum dolorem denique propriae, est at quod hinc tation. Sit enim graeco id. Ne percipit definitionem conclusionemque ius, pro no etiam tamquam volumus. Probo erant postea id duo.An eam iisque facilisi, ad iisque noluisse detraxit his. Clita oportere ei nam. Id mei odio dicam. Has id mucius repudiandae, id noster habemus omittantur cum.',
                'placeName': 'The Murder House',
                'type': 'Murder',
                'relatedPeople': [
                  {
                    name: 'Arthur Ribchest'
                  },
                  {
                    name: 'Kevin Mintballs'
                  }
                ]
              }
            },
            {
              'type': 'Feature',
              'geometry': {
                'type': 'Polygon',
                'coordinates': [
                  [
                    [20.78338623046875, 41.072104440201606],
                    [21.78338623046875, 41.072104440201606],
                    [21.78338623046875, 42.072104440201606],
                    [20.78338623046875, 42.072104440201606],
                    [20.78338623046875, 41.072104440201606]
                  ]
                ]
              },
              'properties': {
                'eventName': 'Murder at the Bob Shop',
                'eventDescription': 'Lorem ipsum dolor sit amet, vim no nemore vidisse, in nec putent mentitum, in eos eros signiferumque. Ea vel quodsi alterum fastidii. Autem quando nostro ut eos, ubique eligendi at cum. Enim autem has ex. Sea nominavi dissentias ad, facilis accumsan in his, sed option indoctum ad.Argumentum interpretaris est no, ei quo suas suscipit contentiones, duo et assum conceptam. Qui natum referrentur cu. Vix an veniam tibique referrentur. His cu mollis explicari, no libris vivendo sensibus vim, nec et animal delenit. Duo no tractatos consetetur voluptatum, cu eos deserunt accusata hendrerit. Quo eu clita qualisque voluptaria, mel ex dolore petentium. Qui te vulputate voluptatum suscipiantur, ex simul argumentum mel, vim docendi salutandi dissentiunt id.',
                'placeName': 'The Bob Shop',
                'type': 'Murder',
                'relatedPeople': [
                  {
                    name: 'Alan Pumptruck'
                  },
                  {
                    name: 'Kevin Mintballs'
                  }
                ]
              }
            }
          ]
        }
      }
    },

    // CALLED FROM LEAFLET MAP LOAD EVENT FIRING
    mapReady: function() {

      // Set up Leaflet Draw
      this.setUpLeafletDraw();

      // Set the max bounds
      this.setMaxBounds();
    },

    // Set the bounds limitations
    // ToDO: Set bounds based off supplied coordinates
    setMaxBounds: function() {

      // Need this as mapReady is called several times. I would have expected leaflet map's load event to only fire once
      // but it doesn't.
      if (this.$.LeafletMap.map.maxBounds) {
        return;
      }

      var southWest = {
        lat: 36.66841891894786,
        lng: 16.226806640625
      };
      var northEast = {
        lat: 43.572431747409745,
        lng: 26.531982421874996
      };

      this.$.LeafletMap.map.setMaxBounds(window.L.latLngBounds(southWest, northEast));
    },

    // Leaflet seems to need a kick to resize tiles when navigating to and from a map view
    resizeMap: function() {
      this.$.LeafletMap.fire('resize');
    },

    // Set up the annotation functionality
    setUpLeafletDraw: function() {

      var drawnItems;
      var styleEditor;

      if (this.drawFunctionalityAdded) {
        return;
      }

      //Initialize the StyleEditor
      styleEditor = window.L.control.styleEditor({
        position: 'topleft',
        useGrouping: false
      });

      this.$.LeafletMap.map.addControl(styleEditor);

      drawnItems = new window.L.FeatureGroup();

      this.$.LeafletMap.map.addLayer(drawnItems);

      var drawControl = new window.L.Control.Draw({
        draw: {
          position: 'topleft',
          polygon: {
            title: 'Draw a polygon',
            allowIntersection: false,
            drawError: {
              color: '#b00b00',
              timeout: 1000
            },
            shapeOptions: {
              color: '#bada55'
            },
            showArea: true
          },
          polyline: {
            metric: false
          },
          circle: {
            shapeOptions: {
              color: '#662d91'
            }
          }
        },
        edit: {
          featureGroup: drawnItems
        }
      });

      this.$.LeafletMap.map.addControl(drawControl);

      this.$.LeafletMap.map.on('draw:created', function(e) {
        //var type = e.layerType;
        var layer = e.layer;

        /*if (type === 'marker') {
          layer.bindPopup('A popup!');
        }*/

        drawnItems.addLayer(layer);
      });

      this.$.LeafletMap.map.on('styleeditor:changed', function(element) {
        console.log(element);
      });

      this.drawFunctionalityAdded = true;
    }
  });
})();
</script>
