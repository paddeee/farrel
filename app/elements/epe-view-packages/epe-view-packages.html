<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-view-packages">
  <style>
    :host {
      display: block;
      min-height: 80vh;
    }

    iron-list {
      background-color: var(--paper-grey-200);
      min-height: inherit;
      --iron-list-items-container: {
         max-width: 75vw;
         margin: auto;
         margin-top: 20px;
         margin-bottom: 20px;
         border-bottom: 0 none;
       };
    }

    .item {
      padding: 8px;
    }

    paper-card {
      background-color: var(--primary-background-color);
      padding: 16px;
      width: 100%;
      --paper-card-header-text: {
         font-size: 2.5vh;
         padding: 0 0 1vh;
      };
      --paper-card-content: {
         font-size: 2vh;
         padding: 0 0 1vh;
       };
      --paper-card-actions: {
         padding: 2vh 0 0;
       };
    }

    paper-button {
      font-size: 2vh;
      margin: 0;
    }

    .user-name {
      margin-right: 1vw;
    }

    .user-name__name {
      font-weight: bold;
    }

    iron-icon {
      margin-left: 1vw;
    }

    .traffic-lights {
      font-size: 1.5vh;
      position: absolute;
      right: 0;
      top: -4vh;
    }

    .traffic-lights__status {
      margin-bottom: 1vh;
    }

    iron-icon.red {
      color: var(--paper-red-500);
    }

    iron-icon.amber {
      color: var(--paper-orange-500);
      margin-left: 1vw;
    }

    iron-icon.green {
      color: var(--paper-green-500);
    }

    .expand__icon {
      cursor: pointer;
    }

    .collapse-content {
      display: none;
    }

    .expanded .collapse-content {
      display: block;
    }

    .expanded .expand__icon--more,
    .expand__icon {
      display: none;
    }

    .expanded .expand__icon--less,
    .expand__icon--more {
      display: block;
    }

    .notes {
      font-style: italic;
      margin: 1vh 0;
    }

    .notes p {
      margin: 0.5vh 0 1vh;
    }

    paper-checkbox {
      --paper-checkbox-label-color: var(--secondary-text-color);
      --paper-checkbox-unchecked-color: var(--secondary-text-color);
      font-size: 1.7vh;
    }

    .submit-package {
      margin: 3vh 0 0;
    }

    paper-button > iron-icon {
      height: 2.5vh;
      width: 2.5vh;
    }

    .export-button {
      background-color: var(--default-primary-color);
      color: var(--text-primary-color);
    }

    .export-dialog {
      width: 50vw;
    }

    paper-input {
      --paper-input-container-color: var(--secondary-text-color);
      --paper-input-container-focus-color: var(--dark-primary-color);
      --paper-input-container-input-color: var(--secondary-text-color);
      --paper-input-container-invalid-color: var(--google-red-500);
      margin: 2vh 0;
    }
  </style>
  <template>

    <iron-list id="List" items="[[presentationsData]]" as="item">
      <template>
        <div class="item">
          <paper-card elevation="1" heading="[[item.presentationName]]">
            <div class="card-content">
              <div class="visible-content layout horizontal center" on-tap="collapseExpand">
                <div class="user-name">
                  Created by <span class="user-name__name">[[item.userName]]</span> -
                </div>
                <div>[[formatCreatedDate(item.createdDate)]]</div>
                <div class="expand">
                  <iron-icon
                    class="expand__icon  expand__icon--more"
                    icon="expand-more"></iron-icon>
                    <paper-tooltip>More info</paper-tooltip>
                  <iron-icon
                    class="expand__icon  expand__icon--less"
                    icon="expand-less"></iron-icon>
                </div>
                <div class="traffic-lights flex layout vertical end-justified">
                  <div class="traffic-lights__status gatekeeper-state layout horizontal center">
                    <div class="flex">Registry Status</div>
                    <iron-icon
                      class$="[[item.gateKeeperState]]"
                      icon="image:lens"></iron-icon>
                    <paper-tooltip>Registry Status</paper-tooltip>
                  </div>
                  <div class="traffic-lights__status authoriser-state layout horizontal center">
                    <div class="flex">Authorised Status</div>
                    <iron-icon
                      class$="[[item.authoriserState]]"
                      icon="image:lens"></iron-icon>
                    <paper-tooltip>Authorised Status</paper-tooltip>
                  </div>
                </div>
              </div>
              <div class="collapse-content">
                <div class="notes" hidden$="[[!item.notes.length]]">
                  Notes: <p>[[item.notes]]</p>
                </div>
                <div class="submit-package" hidden$="[[!isUserCreatedPackage(item.userName)]]">
                  <paper-checkbox
                    id="MarkForApproval"
                    class="submit-package__approval"
                    checked$="[[isMarkedApproved(item)]]"
                    on-change="approvalStateChanged">Mark for Registry Approval</paper-checkbox>
                </div>
                <div class="submit-package"
                     hidden$="[[!isGateKeeperAndNotOwnPackage(item.gateKeeperState, item.authoriserState, item.userName)]]">
                  <paper-checkbox
                    id="GateKeeperApproval"
                    class="submit-package__approval"
                    checked$="[[isMarkedGateKeeperApproved(item)]]"
                    on-change="gateKeeperStateChanged">Mark for Authoriser Approval</paper-checkbox>
                </div>
                <div class="submit-package"
                     hidden$="[[!isAuthoriser(item.authoriserState, item.userName)]]">
                  <paper-checkbox
                    id="AuthoriserApproval"
                    class="submit-package__approval"
                    checked$="[[isMarkedAuthoriserApproved(item)]]"
                    on-change="authoriserStateChanged">Mark as approved for Export</paper-checkbox>
                </div>
              </div>
            </div>
            <div class="card-actions layout horizontal center">
              <div class="flex">
                <paper-button id="ViewPackageButton"
                              raised
                              on-tap="viewPackageSelected">
                  View Package<iron-icon icon="visibility"></iron-icon>
                </paper-button>
              </div>
              <div hidden$="[[hideExportButton(item.authoriserState)]]">
                <paper-button raised
                              class="export-button"
                              on-tap="exportPackageSelected">
                  Export Package<iron-icon icon="file-upload"></iron-icon>
                </paper-button>
              </div>
            </div>
          </paper-card>
        </div>

      </template>
      </iron-list>

    <paper-dialog id="NoYubiKeyDialog" modal>
      <h2>YubiKey not Inserted</h2>
      <div>
        <span>[[yubiKeyMessage]]</span>
      </div>
      <div class="buttons">
        <paper-button dialog-confirm autofocus>OK</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="ExportDialog"
                  class="export-dialog"
                  modal>
      <h2>Export Package</h2>
      <div>
        <paper-input
          id="ExportPassword"
          class="export-package"
          label="Enter Package Password, Then Hold Down YubiKey Button"
          type="password"
          autofocus
          on-keypress="yubiKeyPressed"></paper-input>
      </div>
      <div class="buttons">
        <paper-button dialog-confirm autofocus>Cancel</paper-button>
      </div>
    </paper-dialog>

  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: 'epe-view-packages',

    properties: {

      presentationsData: {
        type: Array
      },

      yubiKeyMessage: {
        type: String
      }
    },

    ready: function() {

      if (this.presentationsStore) {

        // When the presentations data is updated, set this view's presentationsData
        this.presentationsStore.listen(function(presentationsStore) {

          // ToDo: Don't know why I have to do this with iron-list. When presentationData array
          // changes I would expect the template to update but it isn't. In meantime, forcing it
          // by clearing the array and resetting it.
          this.presentationsData = [];

          this.presentationsData = presentationsStore.presentationsData;

          this.$.List.items = this.presentationsData;

        }.bind(this));
      }

      if (this.exportStore) {

        // When the events data is updated, update our grid data
        this.exportStore.listen(function (exportStore) {

          if (exportStore.message) {
            this.handleExportStoreBroadcast(exportStore.message);
          }
        }.bind(this));
      }
    },

    // Handle the broadcast from the export Store
    handleExportStoreBroadcast: function(messageType) {

      // If no yubi key is inserted
      if (messageType === 'noYubiKey') {
        this.message = 'Please insert your YubiKey to export this package.';
        this.$.NoYubiKeyDialog.open();

      // If a YubiKey is inserted
      } else if (messageType === 'yubiKeyInserted') {
        this.$.ExportDialog.open();
      }
    },

    // Return a friendly date
    formatCreatedDate: function(timeStamp) {
      return app.moment(timeStamp).calendar();
    },

    // Handle expanded content for a list item
    collapseExpand: function(event) {

      var list = this.$.List;
      var index = event.model.index;
      var $item = event.currentTarget.closest('.item');

      this.getClassForItem($item, true);
      list.updateSizeForItem(index);
    },

    // Return expanded class for an item
    getClassForItem: function($item) {
      if ($item.classList.contains('expanded')) {
        $item.classList.remove('expanded');
      } else {
        $item.classList.add('expanded');
      }
    },

    // Checkbox has been changed in marking for approval.
    approvalStateChanged: function(event) {

      var $item = event.currentTarget.closest('.item');
      var $gateKeeperTrafficLight = $item.querySelector('.gatekeeper-state iron-icon');
      var $authoriserTrafficLight = $item.querySelector('.authoriser-state iron-icon');

      if (event.target.checked) {
        event.model.item.gateKeeperState = 'amber';
        event.model.item.authoriserState = 'red';
      } else {
        event.model.item.gateKeeperState = 'red';
        event.model.item.authoriserState = 'red';
      }

      // Set the change to the DOM due to template not auto updating
      this.updateTrafficLights($gateKeeperTrafficLight, event.model.item.gateKeeperState, $authoriserTrafficLight, event.model.item.authoriserState);

      // Call approvalStateChanged action
      this.presentationsActions.approvalStateChanged(event.model.item);
    },

    // Checkbox has been changed by GateKeeper.
    gateKeeperStateChanged: function(event) {

      var $item = event.currentTarget.closest('.item');
      var $gateKeeperTrafficLight = $item.querySelector('.gatekeeper-state iron-icon');
      var $authoriserTrafficLight = $item.querySelector('.authoriser-state iron-icon');

      if (event.target.checked) {
        event.model.item.gateKeeperState = 'green';
        event.model.item.authoriserState = 'amber';
      } else {
        event.model.item.gateKeeperState = 'amber';
        event.model.item.authoriserState = 'red';
      }

      // Set the change to the DOM due to template not auto updating
      this.updateTrafficLights($gateKeeperTrafficLight, event.model.item.gateKeeperState, $authoriserTrafficLight, event.model.item.authoriserState);

      // Call approvalStateChanged action
      this.presentationsActions.approvalStateChanged(event.model.item);
    },

    // Checkbox has been changed by Authoriser.
    authoriserStateChanged: function(event) {

      var $item = event.currentTarget.closest('.item');
      var $gateKeeperTrafficLight = $item.querySelector('.gatekeeper-state iron-icon');
      var $authoriserTrafficLight = $item.querySelector('.authoriser-state iron-icon');

      if (event.target.checked) {
        event.model.item.gateKeeperState = 'green';
        event.model.item.authoriserState = 'green';
      } else {
        event.model.item.gateKeeperState = 'green';
        event.model.item.authoriserState = 'amber';
      }

      // Set the change to the DOM due to template not auto updating
      this.updateTrafficLights($gateKeeperTrafficLight, event.model.item.gateKeeperState, $authoriserTrafficLight, event.model.item.authoriserState);

      // Call approvalStateChanged action
      this.presentationsActions.approvalStateChanged(event.model.item);
    },

    // Have to do this manually as the functions inside the template don't get called
    // when the presentationsData is updated.
    // ToDo: Find a better way to let the iron-list manage this if its possible
    updateTrafficLights: function($gateKeeperTrafficLight, gateKeeperState, $authoriserTrafficLight, authoriserState) {
      $gateKeeperTrafficLight.classList.remove('green','amber','red');
      $gateKeeperTrafficLight.classList.add(gateKeeperState);
      $authoriserTrafficLight.classList.remove('green','amber','red');
      $authoriserTrafficLight.classList.add(authoriserState);
    },

    // Used to set the checked state on the checkbox
    isMarkedApproved: function(item) {

      if (item.gateKeeperState === 'red') {
        return false;
      } else {
        return true;
      }
    },

    // Used to set the checked state on the checkbox
    isMarkedGateKeeperApproved: function(item) {

      if (item.authoriserState === 'red') {
        return false;
      } else {
        return true;
      }
    },

    // Used to set the checked state on the checkbox
    isMarkedAuthoriserApproved: function(item) {

      if (item.authoriserState === 'amber') {
        return false;
      } else {
        return true;
      }
    },

    // If the package created by the user is the same as the logged in user
    isUserCreatedPackage: function(userName) {

      if (this.userStore.user.userName === userName) {
        return true;
      } else {
        return false;
      }
    },

    // Is the state waiting for gatekeeper approval or
    // Is the state waiting for authoriser approval and
    // The state is not authoriser approved and
    // is the user a GateKeeper and
    // is the package not the GateKeeper's own
    isGateKeeperAndNotOwnPackage: function(gateKeeperState, authoriserState, userName) {

      if ((gateKeeperState === 'amber' || gateKeeperState === 'green') && authoriserState !== 'green' && this.userStore.user.role === 'gatekeeper' && !this.isUserCreatedPackage(userName)) {
        return true;
      } else {
        return false;
      }
    },

    // Is the state waiting for authoriser approval or
    // is the user an Authoriser
    isAuthoriser: function(authoriserState, userName) {

      if ((authoriserState === 'amber' || authoriserState === 'green') && this.userStore.user.role === 'authoriser' && !this.isUserCreatedPackage(userName)) {
        return true;
      } else {
        return false;
      }
    },

    // Get presentation state based on user
    getPresentationState: function(presentationItem) {

      if (this.isMarkedApproved(presentationItem)) {
        return 'viewingLocked';
      }

      if (this.isUserCreatedPackage(presentationItem.userName)) {
        return 'editing';
      } else {
        return 'viewing';
      }
    },

    // View Package action button pressed
    viewPackageSelected: function(event) {

      var presentationName = event.model.item.presentationName;
      var presentationState = this.getPresentationState(event.model.item);

      // Call presentationStateChanged presentations action
      this.presentationsActions.presentationStateChanged({
        presentationState: presentationState,
        presentationName: presentationName
      });

      // Call packageSelected filterState action
      this.filterStateActions.packageSelected(presentationName);

      // Navigate to Data Grid Events tab
      page('/edit-package/data-grid/Events');
    },

    // Export Package action button pressed
    exportPackageSelected: function(event) {

      this.presentationForExport = event.model.item.presentationName;

      // Perform export if in packaged app. Otherwise log so we know it won't work in browser
      if (typeof global === 'object') {

        // Check YubiKey is inserted
        this.exportActions.yubiKeyCheck();
      } else {
        console.warn('Export not required in browser mode');
      }
    },

    // When the Yubikey Password has been entered
    yubiKeyPressed: function(event) {

      var packagePassword;

      // YubiKey will press enter after entering its password
      if (event.keyCode === 13) {

        packagePassword = event.target.value;

        // Close the Export Dialog and reset the password field
        this.$.ExportPassword.value = null;
        this.$.ExportDialog.close();

        // Call presentationStateChanged presentations action
        this.exportActions.exportPresentation({
          packageName: this.presentationForExport,
          packagePassword: packagePassword
        });
      }

    },

    // Export Package action button pressed
    hideExportButton: function(authoriserState) {

      if ((this.userStore.user.role === 'gatekeeper' || this.userStore.user.role === 'admin') && authoriserState === 'green') {
        return false;
      } else {
        return true;
      }
    }
  });
})();
</script>
