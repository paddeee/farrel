<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-filters">
  <style>

    :host {
      display: block;
    }

    .filters {
      box-shadow: 0 1px 7px rgba(0, 0, 0, 0.65);
      padding: 50px 0 0;
      height: calc(100% - 50px);
      right: 0;
      min-height: 300px;
      background-color: rgba(247, 247, 247, 1);
      width: 30vw;
      position: absolute;
      margin: 0px;
      overflow: hidden;
      -webkit-transition-property: -webkit-transform, width;
      transition-property: transform, width;
      -webkit-transition-duration: 100ms;
      transition-duration: 100ms;
      -webkit-transition-timing-function: ease-in;
      transition-timing-function: ease-in;
      -ms-transform: translatex(31vw);
      -webkit-transform: translatex(31vw);
      transform: translatex(31vw);
      z-index: 10;
    }

    .filters--enabled {
      -ms-transform: translatex(0);
      -webkit-transform: translatex(0);
      transform: translatex(0);
    }

    .filters-header {
      position: absolute;
      left: 0;
      top: 0;
      height: 40px;
      background-color: var(--default-primary-color);
      color: var(--text-primary-color);
      box-sizing: border-box;
      width: 100%;
    }

    .filters-main {
      padding: 0 2vw 8vh;
      overflow: auto;
      position: relative;
      right: 0px;
      height: 100%;
      box-sizing: border-box;
    }

    paper-input {
      --paper-input-container-color: var(--secondary-text-color);
      --paper-input-container-focus-color: var(--dark-primary-color);
      --paper-input-container-input-color: var(--secondary-text-color);
    }

    paper-dropdown-menu {

      outline: none;

      --paper-input-container-color: var(--primary-text-color);
      --paper-input-container-focus-color: var(--dark-primary-color);

      --paper-input-container-label: {
         color: var(--secondary-text-color);
       };

      --paper-input-container-input: {
         color: var(--primary-text-color);
       };
    }

    .filters__custom-search {
      padding: 1vh 0;
    }

    h1 {
      font-size: 1.8vw;
    }

    .filter__button-add {
      font-size: 1.5vw;
    }

    .add-button {
      position: absolute;
      top: 20px;
      right: 1vw;
      color: var(--primary-text-color);
    }

    .search-button {
      background-color: var(--default-primary-color);
      position: absolute;
      bottom: 2vh;
      right: 1vw;
    }

    .filters__no-filters {
      font-size: 1.6vw;
    }

    paper-dialog paper-button {
      color: var(--dark-primary-color);
    }

    paper-radio-group {
      margin: 3vh 0 0;
    }

    .filter-type,
    .include-exclude{
      display: none;
    }

    .filter-type[showing] {
      display: block;
    }

    .include-exclude[showing] {
      display: inline;
    }

    paper-material {
      margin: 1vh 0 2vh;
      padding: 2vh 2vw;
      background: var(--primary-background-color);
    }

    .filter-info {
      font-size: 1.7vw;
    }

    .include-exclude-data-type {
      font-style: italic;
    }

    .remove-filter {
      color: var(--paper-red-500);
      position: absolute;
      top: 0;
      right: 0;
    }

  </style>
  <template>

    <div id="Filters" class="filters">
      <div class="filters-header">
        <paper-icon-button
          id="MenuButton"
          class="menu-button"
          icon="close"
          on-tap="hideFilters"></paper-icon-button>
        <paper-tooltip for="MenuButton" position="right">
          Hide Filters
        </paper-tooltip>
      </div>
      <div class="filters-main">

        <div class="filters__global-search">
          <paper-input id="GlobalSearch"
                       type="search"
                       label="Global search"
                       value="[[globalSearchValue]]">
          </paper-input>
        </div>

        <div class="filters__custom-search layout vertical center-justified">
          <h1 class="self-center">Custom Filters</h1>
          <div class="filters__custom-container"
            hidden$="[[hideCustomFilters]]">
            <template id="FiltersTemplate" is="dom-repeat" items="[[customFilters]]">

              <paper-material class="filter-item">

                <!-- Input -->
                <div class="filter-type  filter-type--input"
                  showing$="[[showFilterType('regex',item.filter)]]">
                  <paper-input type="search"
                               label="[[item.fieldName]]"
                               value="[[item.value]]">
                  </paper-input>
                </div>

                <!-- Select -->
                <paper-dropdown-menu class="filter-type  filter-type--select"
                                     label="[[item.fieldName]]"
                                     showing$="[[showFilterType('select',item.filter)]]">
                  <paper-listbox class="dropdown-content"
                                 attr-for-selected="value"
                                 selected="[[item.value]]">
                    <paper-item value="">Select&nbsp;<span> [[item.fieldName]]</span></paper-item>
                    <template id="FilterValuesTemplate"
                              is="dom-repeat"
                              items="[[item.filterValues]]"
                              as="filterValue">
                      <paper-item value$="[[filterValue]]">[[filterValue]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>


                <!-- DateTime -->

                <div class="filter-info">
                  <span showing$="[[showIncludeExcludeFilter('include',item.includeExclude)]]"
                        class="include-exclude">In </span>
                  <span showing$="[[showIncludeExcludeFilter('exclude',item.includeExclude)]]"
                        class="include-exclude">Not in </span>
                  <span class="include-exclude-data-type">[[item.fieldName]]</span>
                  <span>field of </span>
                  <span class="include-exclude-data-type">[[item.collectionDisplayName]]</span>
                  <span> table.</span>
                </div>

                <paper-icon-button class="remove-filter"
                                   icon="remove-circle"
                                   on-tap="removeFilter"
                                   data-index$="[[index]]"></paper-icon-button>
                <paper-tooltip position="top">
                  Remove Filter
                </paper-tooltip>
              </paper-material>
            </template>
          </div>

          <!-- No filters message -->
          <div class="filters__no-filters"
               hidden$="[[!hideCustomFilters]]">
            Press the yellow add button above to add a custom filter.
          </div>
        </div>
      </div>

      <paper-fab id="AddButton"
                 class="add-button"
                 icon="add"
                 mini
                 on-tap="addFilter"></paper-fab>

      <paper-fab id="SearchButton"
                 class="search-button"
                 icon="search"></paper-fab>

      <!-- Tooltips -->
      <paper-tooltip for="AddButton">
        Add a Custom Filter
      </paper-tooltip>
      <paper-tooltip for="SearchButton" position="top">
        Perform Filtered Search
      </paper-tooltip>
    </div>

    <!-- Add Filter Dialog -->
    <paper-dialog id="AddFilterDialog" modal>
      <h2>Add filter</h2>
      <paper-dialog-scrollable>

        <div class="layout vertical">

        <!-- Data Type -->
        <paper-dropdown-menu id="AddFilterDataType" label="Search on..">
          <paper-listbox id="AddFilterDataTypeList"
                         class="dropdown-content"
                         on-iron-select="dataTypeSelected">
            <paper-item value$="[[eventsName]]">Events</paper-item>
            <paper-item value$="[[placesName]]">Places</paper-item>
            <paper-item value$="[[peopleName]]">People</paper-item>
            <paper-item value$="[[sourcesName]]">Source Material</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>

        <paper-dropdown-menu id="AddField" label="in field.." disabled>
          <paper-listbox id="AddFieldList"
                         class="dropdown-content">
            <template id="AddFieldTemplate" is="dom-repeat" items="[[fields]]">
              <paper-item value$="[[item]]">[[item.name]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>

        <paper-radio-group id="IncludeExclude" selected="include">
          <paper-radio-button name="include">Include in search</paper-radio-button>
          <paper-radio-button name="exclude">Exclude from search</paper-radio-button>
        </paper-radio-group>

        </div>

      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss
                      on-tap="addFilterCancelled">Cancel</paper-button>
        <paper-button on-tap="filterAdded">Add Filter</paper-button>
      </div>
    </paper-dialog>

    <!-- Invalid filter dialog -->
    <paper-dialog id="InvalidFilterAddedDialog" modal>
      <h2>Invalid Filter</h2>
      <div>[[invalidFilterMessage]]</div>
      <div class="layout horizontal end-justified">
        <paper-button dialog-dismiss>OK</paper-button>
      </div>
      </paper-dialog>

  </template>
</dom-module>
<script>
  (function() {
    Polymer({
      is: 'epe-filters',

      behaviours: [
        Polymer.IronValidatorBehaviour
      ],

      properties: {

        // Whether filters editor is shown
        showFilters: {
          type: Boolean,
          value: false,
          notify: true,
          observer: 'toggleFilters'
        },

        globalSearchValue:  {
          type: String,
          value: ''
        },

        customFilters:  {
          type: Array
        },

        hideCustomFilters: {
          type: Boolean,
          value: true
        },

        fields: {
          type: Array,
          value: []
        },

        invalidFilterMessage: {
          type: String
        }
      },

      ready: function() {

        // Set properties on this element so we can use the values in the template
        this.eventsName = app.config.EventsCollection.name;
        this.placesName = app.config.PlacesCollection.name;
        this.peopleName = app.config.PeopleCollection.name;
        this.sourcesName = app.config.SourcesCollection.name;

        if (this.queryBuilderStore) {

          // When the presentations data is updated
          this.queryBuilderStore.listen(function(queryBuilderStore) {

            // Set Global Search Value
            this.globalSearchValue = queryBuilderStore.queryObject.globalSearchValue;

            // Set Custom Filters - Need to set array to empty so observable will pick up change to customFilters array
            this.customFilters = [];

            queryBuilderStore.queryObject.filters.forEach(function(queryObject) {
              this.push('customFilters', queryObject);
            }.bind(this));

            // Decide whether to show No custom filters message
            this.showHideCustomFilters();

          }.bind(this));
        }
      },

      // Hide filters editor
      hideFilters: function() {
        this.showFilters = false;
      },

      // Show/Hide filters editor
      toggleFilters: function() {

        var $filters = this.$.Filters;

        if (this.showFilters) {
          $filters.classList.add('filters--enabled');
        } else {
          $filters.classList.remove('filters--enabled');
        }
      },

      // If custom filters is empty set hideCustomFilters to false
      showHideCustomFilters: function() {

        if (this.customFilters && this.customFilters.length > 0) {
          this.hideCustomFilters = false;
        } else {
          this.hideCustomFilters = true;
        }
      },

      // Add filter button tapped
      addFilter: function() {
        this.$.AddFilterDialog.open();
      },

      // Select Data Type dropdown changed
      dataTypeSelected: function(event) {

        this.deselectField(this.$.AddFieldList);

        switch (event.detail.item.innerText) {
          case 'Events':
            this.fields = app.config.EventsCollection.fields.filter(function(item) {
              return item.display === 'true';
            });
            break;
          case 'Places':
            this.fields = app.config.PlacesCollection.fields.filter(function(item) {
              return item.display === 'true';
            });
            break;
          case 'People':
            this.fields = app.config.PeopleCollection.fields.filter(function(item) {
              return item.display === 'true';
            });
            break;
          case 'Source Material':
            this.fields = app.config.SourcesCollection.fields.filter(function(item) {
              return item.display === 'true';
            });
            break;
          default:
            console.error('InnerText of selected item does not match any of these cases');
        }

        this.$.AddField.disabled = false;
      },

      // Deselect selected item in field dropdown
      deselectField: function(dropdown) {
        dropdown.selected = undefined;
      },

      // Reset Add filter Dialog form
      addFilterCancelled: function() {
        this.deselectField(this.$.AddFilterDataTypeList);
        this.deselectField(this.$.AddFieldList);
        this.$.IncludeExclude.selected = 'include';
        this.$.AddField.disabled = true;
      },

      // ToDo: Use Iron Validators instead of dialog to validate the form
      validateDataType: function(value) {
        console.log(value);
      },

      // Check filter to be added is valid
      filterValidate: function() {

        var valid = true;

        // If no data type has been selected
        if (!this.$.AddFilterDataTypeList.selectedItem) {
          valid = false;
          this.invalidFilterMessage = 'Please select a data type to search on.'
          this.$.InvalidFilterAddedDialog.open();
        }

        // If no data field has been selected
        else if (!this.$.AddFieldList.selectedItem) {
          valid = false;
          this.invalidFilterMessage = 'Please select a field to search on.'
          this.$.InvalidFilterAddedDialog.open();
        }

        return valid;
      },

      // Add a filter and pass filters Object via 'queryFiltersChanged' action
      filterAdded: function() {

        // If filter to be added is valid
        if (this.filterValidate()) {

          var item = JSON.parse(this.$.AddFieldList.selectedItem.getAttribute("value"));

          var filterObject = {
            collectionName: this.$.AddFilterDataTypeList.selectedItem.getAttribute("value"),
            collectionDisplayName: this.$.AddFilterDataTypeList.selectedItem.innerText.trim(),
            fieldName: item.name,
            filter: item.filter,
            filterValues: item.filterValues,
            includeExclude: this.$.IncludeExclude.selected,
            value: ''
          };

          this.$.AddFilterDialog.close();

          this.addFilterCancelled();

          this.queryBuilderActions.queryFiltersChanged(filterObject, 'add');
        }
      },

      // CALLED IN TEMPLATE TO HIDE NON RELEVANT FILTER ELEMENTS
      showFilterType: function(elementType, filterType) {

        if (elementType === filterType) {
          return true;
        }
        return false;
      },

      // CALLED IN TEMPLATE TO HIDE NON RELEVANT INCLUDE/EXCLUDE FILTER MESSAGES
      showIncludeExcludeFilter: function(elementType, includeExcludeType) {

        if (elementType === includeExcludeType) {
          return true;
        }
        return false;
      },

      // Remove filter from collection
      removeFilter: function(event) {

        var index = JSON.parse(event.currentTarget.dataset.index);

        this.queryBuilderActions.queryFiltersChanged(index, 'remove');
      }
    });
  })();
</script>
