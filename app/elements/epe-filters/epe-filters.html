<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-filters">
  <style>

    :host {
      display: block;
    }

    .filters-main::-webkit-scrollbar {
      background-color: whitesmoke;
    }

    .filters {
      box-shadow: 0 1px 7px rgba(0, 0, 0, 0.65);
      padding: 50px 0 0;
      height: calc(100% - 50px);
      right: 0;
      min-height: 300px;
      background-color: whitesmoke;
      width: 30vw;
      max-width: 300px;
      position: fixed;
      margin: 0px;
      overflow: hidden;
      -webkit-transition-property: -webkit-transform, width;
      transition-property: transform, width;
      -webkit-transition-duration: 300ms;
      transition-duration: 300ms;
      -webkit-transition-timing-function: ease-in-out;
      transition-timing-function: ease-in-out;
      -ms-transform: translatex(31vw);
      -webkit-transform: translatex(31vw);
      transform: translatex(31vw);
      z-index: 10;
    }

    .filters--enabled {
      -ms-transform: translatex(0);
      -webkit-transform: translatex(0);
      transform: translatex(0);
    }

    .filters-header {
      position: absolute;
      left: 0;
      top: 0;
      height: 40px;
      background-color: rgb(0, 158, 194);
      color: var(--text-primary-color);
      box-sizing: border-box;
      width: 100%;
    }

    .filters-main {
      padding: 0 2vw 8vh;
      overflow: auto;
      position: relative;
      right: 0px;
      height: 100%;
      box-sizing: border-box;
    }

    paper-input {
      --paper-input-container-color: var(--secondary-text-color);
      --paper-input-container-focus-color: var(--dark-primary-color);
      --paper-input-container-input-color: var(--secondary-text-color);

      --paper-input-container-label: {
         font-size: 12px;
       };
    }

    paper-dropdown-menu {

      outline: none;

      --paper-input-container-color: var(--primary-text-color);
      --paper-input-container-focus-color: var(--dark-primary-color);
      --paper-input-container-invalid-color: var(--paper-red-500);

      --paper-input-container-label: {
         color: var(--secondary-text-color);
       };

      --paper-input-container-input: {
         color: var(--primary-text-color);
       };
    }

    .filters__custom-search {
      padding: 1vh 0;
    }

    h2 {
      font-size: 14px;
      text-align: center;
    }

    .filter__button-add {
      font-size: 1.5vw;
    }

    .add-button {
      position: absolute;
      top: 20px;
      right: 1vw;
      color: var(--primary-text-color);
    }

    .save-button {
      background-color: var(--default-primary-color);
      position: absolute;
      bottom: 2vh;
      right: 1vw;
    }

    .no-save-message {
      position: absolute;
      bottom: 2vh;
      right: 1vw;
      font-size: 14px;
      padding: 2vh 2vw;
      font-weight: bold;
      text-align: center;
    }

    .filters__no-filters {
      font-size: 12px;
      text-align: center;
    }

    .filters__results {
      margin: 2vh 0 1vh;
      font-size: 14px;
      font-style: italic;
      text-align: center;
    }

    .results__number {
      font-weight: bold;
    }

    .add-filter-dialog {
      overflow: visible;
      min-width: 380px;
    }

    .add-filter-dialog__container {
      margin: 0;
    }

    paper-dialog paper-button {
      color: var(--dark-primary-color);
    }

    paper-radio-group {
      margin: 3vh 0 0;
    }

    .filter-type--date-time-picker {
      margin: 16px 0 0;
    }

    .field-value-inputs {
      height: 66px;
      width: 100%;
    }

    .include-exclude[showing] {
      display: inline;
    }

    paper-material {
      padding: 1vh 1vw;
      background: var(--primary-background-color);
    }

    .filter-item {
      padding: 8px 0;
    }

    .filter-info {
      font-size: 13px;
    }

    .filter-container-icons paper-icon-button {
      padding: 4px;
      height: 30px;
      width: 30px;
    }

    .remove-filter {
      color: var(--paper-red-500);
    }

    .save-package {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100%;
      width: 100%;
      margin: 0;
      z-index: 11;
      display:none;
    }

    .save-package.save-package--showing {
      display:block;
    }

    .save-package__card {
      height: 85vh;
      background-color: var(--primary-background-color);
      max-width: 70vw;
      margin: 15vh auto 0;
    }

    .save-package-overlay {
      background-color: rgba(0, 0, 0, 0.3);
      display: none;
      opacity: 0;
      height: calc(100% + 128px);
      position: fixed;
    }

    .save-package-overlay.save-package-overlay--showing {
      display: block;
      opacity: 1;
      transition: opacity 0.5s ease-in-out;
      z-index: 10;
    }

    .include-exclude--hidden {
      visibility: hidden;
    }

    .and-or-not {
      margin: 20px 0 0;
    }

    .and-or-not__button-holder {
      margin: 0 0 12px 0;
    }

    .and-or-not paper-button {
      color: var(--primary-text-color);
      font-weight: bold;
      margin: 0 8px 0 0;
    }

    .and-or-not span {
      font-style: italic;
    }

    .and-or-not paper-button[active] {
      background-color: rgb(0, 158, 194);
      color: var(--text-primary-color);
      font-weight: normal;
    }

    .last-filter-condition,
    .global-filter-condition {
      font-size: 11px;
      text-align: center;
      margin: 2vh 0;
      font-weight: bold;
      text-transform: uppercase;
    }

    .main-filter-condition {
      border-bottom: 1px dashed gray;
      border-top: 1px dashed gray;
      font-size: 11px;
      text-align: center;
      padding: 2px 0;
      font-weight: bold;
      text-transform: uppercase;
    }

    .left-border {
      border-left: 1px solid gray;
      height: 6px;
    }

    .dash-holder {
      margin: 2px 0;
    }

    .search-value {
      color: rgb(195, 69, 40);
    }

    .search-field-value {
      color: rgb(67, 105, 120);
    }

    .search-icon {
      height: 26px;
      width: 26px;
      cursor: pointer;
    }

    .filters__global-search {
      width: 85%;
    }

    .search-icon-holder {
      position: absolute;
      right: 0;
      top: 28px;
    }

    .global-search {
      position: relative;
    }

    .filters__custom-container {
      margin: 0 0 2vh;
    }

    .filter-item--date:not(:first-child) {
      border-top: 1px solid var(--divider-color);
    }

  </style>
  <template>

    <div id="Filters" class="filters">
      <div class="filters-header">
        <paper-icon-button
          id="MenuButton"
          class="menu-button"
          icon="close"
          on-tap="hideFilters"></paper-icon-button>
        <paper-tooltip for="MenuButton" position="right">
          Hide Filters
        </paper-tooltip>
      </div>
      <div class="filters-main">

        <div class="global-search">
          <div class="filters__global-search">
            <paper-input id="GlobalSearch"
                         type="search"
                         label="Search in all Event fields"
                         value="[[globalSearchValue]]"
                         on-search="globalSearchChanged">
            </paper-input>
          </div>
          <div class="search-icon-holder">
            <iron-icon class="search-icon" icon="search" on-tap="globalSearchChanged"></iron-icon>
          </div>
        </div>

        <div class="filters__custom-search layout vertical center-justified">

          <!-- No filters message -->
          <div class="filters__no-filters"
               hidden$="[[hideNoFiltersPlaceholder]]">
            Search all fields using the input box above or press the '+' button above to add a custom filter.
          </div>

          <!-- Filter Results -->
          <div class="filters__results"
               hidden$="[[hideFilterResults]]">
            <span>Showing <span class="results__number">[[eventsData.length]]</span> of </span>
            <span class="results__number">[[totalEvents]]</span>
            <span>Events</span>
          </div>

          <!-- Global Filter -->
          <div class="filters__custom-container  filters__custom-container--global"
               hidden$="[[hideGlobalFilter]]">
            <h2>Global Filter</h2>
            <paper-material>
              <div class="filter-item layout horizontal center">
                <div class="filter-info flex">
                  <span class="search-value"><strong>"[[globalFilterValue]]"</strong></span>
                  <span>in </span>
                  <span class="search-field-value"><strong>"All Fields"</strong></span>
                </div>
              </div>
            </paper-material>
          </div>

          <!-- Date Filters -->
          <div class="filters__custom-container  filters__custom-container--main"
               hidden$="[[hideDateFilters]]">
            <h2 hidden$="[[hideDateFilters]]">Date Filters</h2>

            <paper-material>

              <template id="DateFiltersTemplate"
                        is="dom-repeat"
                        items="[[dateFilters]]">

                <div class="filter-item filter-item--date layout horizontal center">

                  <div class="filter-info flex">Where
                    <span class="search-field-value"><strong>"[[getHeadingName(item.fieldName)]]"</strong></span>
                    <span hidden$="[[hideIncludeFilter(item)]]"
                          class="include-exclude">is <strong>after</strong> </span>
                  <span hidden$="[[hideExcludeFilter(item)]]"
                        class="include-exclude">is <strong>before</strong> </span>
                    <span class="search-value"><strong>"[[getFilterDateTime(item.value)]]"</strong></span>
                  </div>

                  <div class="filter-container-icons layout horizontal">
                    <paper-icon-button id="EditFilter"
                                       class="edit-filter"
                                       icon="create"
                                       on-tap="editFilter"
                                       data-index$="[[index]]"></paper-icon-button>
                    <paper-icon-button id="RemoveFilter"
                                       class="remove-filter"
                                       icon="remove-circle"
                                       on-tap="removeFilter"
                                       data-filter$="[[item]]"></paper-icon-button>
                    <paper-tooltip for="EditFilter" position="top">
                      Edit Filter
                    </paper-tooltip>
                    <paper-tooltip for="RemoveFilter" position="top">
                      Remove Filter
                    </paper-tooltip>
                  </div>
                </div>
              </template>
            </paper-material>
          </div>

          <!-- Custom Filters -->
          <h2 hidden$="[[!lastFilter]]">Custom Filters</h2>

          <div class="filters__custom-container  filters__custom-container--main"
            hidden$="[[hideCustomFilters]]">

            <paper-material>

              <template id="FiltersTemplate"
                        is="dom-repeat"
                        items="[[customFilters]]">

                <div hidden$="[[hideMainFilterCondition(index)]]" class="main-filter-condition">
                  <div class="layout horizontal dash-holder">
                    <div class="flex right-border"></div>
                    <div class="flex left-border"></div>
                  </div>
                  <div>[[item.andOrNot]]</div>
                  <div class="layout horizontal dash-holder">
                    <div class="flex"></div>
                    <div class="flex left-border"></div>
                  </div>
                </div>

                <div class="filter-item layout horizontal center">

                  <div class="filter-info flex">
                    <span class="search-value"><strong>"[[item.value]]"</strong></span>
                    <span >in </span>
                    <span class="search-field-value"><strong>"[[getHeadingName(item.fieldName)]]"</strong></span>
                  </div>

                  <div class="filter-container-icons layout horizontal">
                    <paper-icon-button id="EditFilter"
                                       class="edit-filter"
                                       icon="create"
                                       on-tap="editFilter"
                                       data-index$="[[index]]"></paper-icon-button>
                    <paper-icon-button id="RemoveFilter"
                                       class="remove-filter"
                                       icon="remove-circle"
                                       on-tap="removeFilter"
                                       data-filter$="[[item]]"></paper-icon-button>
                    <paper-tooltip for="EditFilter" position="top">
                      Edit Filter
                    </paper-tooltip>
                    <paper-tooltip for="RemoveFilter" position="top">
                      Remove Filter
                    </paper-tooltip>
                  </div>
                </div>
              </template>
            </paper-material>
          </div>

          <!-- Last Filter -->
          <div hidden$="[[hideCustomFilters]]" class="last-filter-condition">[[lastFilterCondition]]</div>

          <div class="filters__custom-container  filters__custom-container--last"
               hidden$="[[!lastFilter]]">

            <paper-material>

              <div class="filter-item layout horizontal center">

                <div class="filter-info flex">
                  <span class="search-value"><strong>"[[lastFilterValue]]"</strong></span>
                  <span>in </span>
                  <span class="search-field-value"><strong>"[[getHeadingName(lastFilterField)]]"</strong></span>
                </div>

                <div class="filter-container-icons layout horizontal">
                  <paper-icon-button id="EditFilter"
                                     class="edit-filter"
                                     icon="create"
                                     on-tap="editFilter"
                                     data-index$="[[index]]"></paper-icon-button>
                  <paper-icon-button id="RemoveFilter"
                                     class="remove-filter"
                                     icon="remove-circle"
                                     on-tap="removeFilter"
                                     last-filter="true"></paper-icon-button>
                  <paper-tooltip for="EditFilter" position="top">
                    Edit Filter
                  </paper-tooltip>
                  <paper-tooltip for="RemoveFilter" position="top">
                    Remove Filter
                  </paper-tooltip>
                </div>
              </div>
            </paper-material>
          </div>
        </div>
      </div>

      <paper-fab id="AddButton"
                 class="add-button"
                 icon="add"
                 mini
                 on-tap="addFilter"></paper-fab>

      <paper-fab id="SavePackageButton"
                 class="save-button"
                 icon="save"
                 on-tap="savePresentation"
                 hidden$="[[hideSaveButton]]"></paper-fab>

      <div class="no-save-message" hidden$="[[hideNoSaveMessage]]">
        This package is awaiting authorisation so cannot currently be saved.
      </div>

      <!-- Tooltips -->
      <paper-tooltip for="AddButton">
        Add a Custom Filter
      </paper-tooltip>
      <paper-tooltip for="SavePackageButton" position="top">
        Save Package
      </paper-tooltip>
      </paper-tooltip>
    </div>

    <!-- Add Filter Dialog -->
    <paper-dialog id="AddFilterDialog" class="add-filter-dialog" modal>
      <h2>Add filter</h2>

        <div class="layout vertical add-filter-dialog__container">

        <paper-dropdown-menu id="AddField"
                             label="on field.."
                             error-message="Please select a field to search on."
                             on-iron-select="fieldSelected"
                             disabled$="[[editingFilter]]">
          <paper-listbox id="AddFieldList"
                         attr-for-selected="name"
                         class="dropdown-content">
            <template id="AddFieldTemplate" is="dom-repeat" items="[[fields]]">
              <paper-item value$="[[item]]"
                          type$="[[item.filter]]"
                          name$="[[getHeadingName(item.name)]]">[[getHeadingName(item.name)]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>

        <div class="field-value-inputs layout horizontal center">

          <!-- Placeholder Disabled Input for Presentational Purposes -->
          <paper-input id="PlaceHolderFieldValueInput"
                       class="flex"
                       type="search"
                       label="Enter Filter Value"
                       value=""
                       disabled>
          </paper-input>

          <!-- Input -->
          <paper-input id="FieldValueInput"
                       class="filter-type  filter-type--input flex"
                       hidden="true"
                       type="search"
                       label="[[getHeadingName(selectedFieldFilterObject.name, 'true')]]"
                       value="[[selectedFieldFilterObject.value]]"
                       on-keypress="textFieldTyped">
          </paper-input>

          <!-- Select -->
          <paper-dropdown-menu id="FieldValueSelect"
                               class="filter-type  filter-type--select flex"
                               hidden="true"
                               label="Choose [[selectedFieldFilterObject.name]]">
            <paper-listbox id="FieldValueListBox"
                           class="dropdown-content"
                           attr-for-selected="value"
                           selected="[[selectedFieldFilterObject.value]]">
              <paper-item value="">Select&nbsp;<span> [[selectedFieldFilterObject.fieldName]]</span></paper-item>
              <template id="FilterValuesTemplate"
                        is="dom-repeat"
                        items="[[selectedFieldFilterObject.filterValues]]"
                        as="filterValue">
                <paper-item value$="[[filterValue]]">[[filterValue]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>

          <!-- DateTime -->
          <epe-date-time-picker
            id="FieldValueDatePicker"
            class="filter-type filter-type--date-time-picker flex"
            label="[[selectedFieldFilterObject.fieldName]]"
            query-type="[[[selectedFieldFilterObject.filter]]"
            date="[[getFilterDate(selectedFieldFilterObject.value)]]"
            time="[[getFilterTime(selectedFieldFilterObject.value)]]"
            hidden="true"></epe-date-time-picker>

        </div>

        <div id="AndOrNot"
             class="and-or-not layout vertical"
             hidden$="[[hideAndOrNot]]">
          <div class="and-or-not__button-holder">
            <paper-button id="And"
                          class="and-or-not__button"
                          on-tap="andOrNotSelected"
                          and-or-not="and"
                          active
                          raised>AND</paper-button>
            <span>Show me only the common elements of both</span>
          </div>
          <div class="and-or-not__button-holder">
            <paper-button id="Or"
                          class="and-or-not__button"
                          on-tap="andOrNotSelected"
                          and-or-not="or"
                          raised>OR</paper-button>
            <span>Add them together so I see all answers</span>
          </div>
          <div class="and-or-not__button-holder">
            <paper-button id="Not"
                          class="and-or-not__button"
                          on-tap="andOrNotSelected"
                          and-or-not="not"
                          raised>NOT</paper-button>
            <span>Exclude from the results</span>
          </div>
        </div>

        <paper-radio-group id="IncludeExclude" selected="include" class="include-exclude  include-exclude--hidden">
          <paper-radio-button name="include">Include in search</paper-radio-button>
          <paper-radio-button name="exclude">Exclude from search</paper-radio-button>
        </paper-radio-group>

        </div>
      <div class="buttons">
        <paper-button dialog-dismiss
                      on-tap="addFilterCancelled">Cancel</paper-button>
        <paper-button id="AddFilterButton" on-tap="filterAdded" hidden$="[[editingFilter]]">Add Filter</paper-button>
        <paper-button id="EditFilterButton" on-tap="filterEdited" hidden$="[[!editingFilter]]">Edit Filter</paper-button>
      </div>
    </paper-dialog>

    <!-- Save Package Overlay card -->
    <div id="SavePackage" class="save-package">
      <paper-material
        class="save-package__card"
        elevation="3">
        <epe-save-package
          user-store="[[userStore]]"
          message="{{message}}"
          presentations-store="[[presentationsStore]]"
          data-source-actions="[[dataSourceActions]]"
          query-builder-actions="[[queryBuilderActions]]"
          on-close-card="closeCard"
          on-show-dialog="showDialog"
          on-syncing-db="syncingDB"></epe-save-package>
      </paper-material>
    </div>

    <div id="SavePackageOverlay" class="save-package-overlay fit"></div>

  </template>
</dom-module>
<script>
  (function() {
    Polymer({
      is: 'epe-filters',

      behaviors: [
        Polymer.NeonAnimationRunnerBehavior
      ],

      properties: {

        // Whether filters editor is shown
        showFilters: {
          type: Boolean,
          value: false,
          notify: true,
          observer: 'toggleFilters'
        },

        savePackageCardOpen: {
          type: Boolean,
          value: false
        },

        globalSearchValue:  {
          type: String,
          value: ''
        },

        dateFilters: {
          type: Array,
          value: []
        },

        customFilters: {
          type: Array,
          value: []
        },

        globalFilterValue: {
          type: String,
          value: ''
        },

        lastFilter: {
          type: Object,
          value: null
        },

        lastFilterValue: {
          type: String,
          value: ''
        },

        lastFilterField: {
          type: String,
          value: ''
        },

        lastFilterCondition: {
          type: String,
          value: ''
        },

        hideFilterResults: {
          type: Boolean,
          value: true
        },

        hideGlobalFilter: {
          type: Boolean,
          value: true
        },

        hideDateFilters: {
          type: Boolean,
          value: true
        },

        hideCustomFilters: {
          type: Boolean,
          value: true
        },

        hideNoFiltersPlaceholder: {
          type: Boolean,
          value: false
        },

        hideAndOrNot: {
          type: Boolean,
          value: true
        },

        fields: {
          type: Array,
          value: []
        },

        selectedFieldFilterObject: {
          type: Object
        },

        invalidFilterMessage: {
          type: String
        },

        selectedDataType: {
          type: String
        },

        hideSaveButton: {
          type: Boolean,
          value: false
        },

        hideNoSaveMessage: {
          type: Boolean,
          value: true
        },

        andOrNotSelectedValue: {
          type: String,
          value: 'and'
        },

        editingFilter: {
          type: Boolean,
          value: false
        },

        totalEvents: {
          type: String,
          value: '0'
        },

        animationConfig: {
          value: function() {
            return {
              'entry': {
                name: 'transform-animation',
                node: this.$.SavePackage,
                transformFrom: 'translateY(100%)',
                transformTo: 'translateY(0)'
              },
              'exit': {
                name: 'transform-animation',
                node: this.$.SavePackage,
                transformFrom: 'translateY(0)',
                transformTo: 'translateY(100%)'
              }
            };
          }
        },

        queryFilterTimeOut: {
          type: String,
          value: ''
        }
      },

      listeners: {
        'neon-animation-finish': 'onSlideAnimationFinish'
      },

      ready: function() {

        // If in PackageViewer App, set config property after package import
        if (presentationMode && presentationMode === 'offline') {

          // When the presentations data is updated
          this.importPackageStore.listen(function (importPackageStore) {

            if (importPackageStore.message === 'importSuccess') {

              this.config = global.config;

              // Set properties on this element so we can use the values in the template
              this.eventsName = this.config.EventsCollection.name;
              this.placesName = this.config.PlacesCollection.name;
              this.peopleName = this.config.PeopleCollection.name;
              this.sourcesName = this.config.SourcesCollection.name;

              this.selectedDataType = this.eventsName;
              this.fields = this.config.EventsCollection.fields.filter(function(item) {
                return item.display === 'true';
              });
            }
          }.bind(this));

        } else {

          this.config = app.config;

          // Set properties on this element so we can use the values in the template
          this.eventsName = this.config.EventsCollection.name;
          this.placesName = this.config.PlacesCollection.name;
          this.peopleName = this.config.PeopleCollection.name;
          this.sourcesName = this.config.SourcesCollection.name;

          this.selectedDataType = this.eventsName;
          this.fields = this.config.EventsCollection.fields.filter(function(item) {
            return item.display === 'true';
          });
        }

        if (this.queryBuilderStore) {

          // When the presentations data is updated
          this.queryBuilderStore.listen(function(queryBuilderStore) {

            // Set Global Search Value
            if (queryBuilderStore.queryObject) {

              this.globalSearchValue = queryBuilderStore.queryObject.globalSearchValue;

              this.createFilterGroups(queryBuilderStore);

              // Decide whether to show No custom filters message
              this.showHideCustomFilters();

              // Decide whether to show No custom filters message
              this.showHideDateFilters();
            }
          }.bind(this));
        }

        if (this.presentationsStore) {

          // When the presentations data is updated
          this.presentationsStore.listen(function(presentationsStore) {

            // Manage the Save Button depending on presentation state
            this.manageSaveButton(presentationsStore.presentationState);

            // Manage the footer message depending on presentation state
            this.manageSaveMessage(presentationsStore.presentationState);

          }.bind(this));
        }
      },

      // Hide filters editor
      hideFilters: function() {
        this.showFilters = false;
      },

      // Show/Hide filters editor
      toggleFilters: function() {

        var $filters = this.$.Filters;

        if (this.showFilters) {
          $filters.classList.add('filters--enabled');
        } else {
          $filters.classList.remove('filters--enabled');
        }
      },

      // If date filters is empty set hideDateFilters to true
      showHideDateFilters: function() {

        if (this.dateFilters && this.dateFilters.length > 0) {
          this.hideDateFilters = false;
          this.hideNoFiltersPlaceholder = true;
        } else {
          this.hideDateFilters = true;

          if (this.hideGlobalFilter) {
            this.hideNoFiltersPlaceholder = false;
          } else {
            this.hideNoFiltersPlaceholder = true;
          }
        }
      },

      // If custom filters is empty set hideCustomFilters to true
      showHideCustomFilters: function() {

        if (this.customFilters && this.customFilters.length > 0) {
          this.hideCustomFilters = false;
          this.hideNoFiltersPlaceholder = true;
        } else {
          this.hideCustomFilters = true;

          if (this.lastFilter) {
            this.hideNoFiltersPlaceholder = true;
          } else {

            if (this.hideGlobalFilter) {
              this.hideNoFiltersPlaceholder = false;
            } else {
              this.hideNoFiltersPlaceholder = true;
            }
          }
        }
      },

      // Add filter button tapped
      addFilter: function() {
        this.editingFilter = false;
        this.andOrNotSelectedValue = 'and';
        this.$.AddFilterDialog.open();

        if (this.customFilters.length < 1) {
          if (this.lastFilter) {
            this.hideAndOrNot = false;
          } else {
            this.hideAndOrNot = true;
          }
        } else {
          this.hideAndOrNot = false;
        }
      },

      // Edit an existing Filter Item
      editFilter: function(event) {

        this.editingFilter = true;
        var fieldItem;

        if (event.model) {
          fieldItem = event.model.item;
        } else {
          fieldItem = this.lastFilter;
        }

        // Set field Value
        this.$.AddFieldList.select(this.getHeadingName(fieldItem.fieldName));

        // Set selectedFieldFilterObject
        this.selectedFieldFilterObject = fieldItem;

        // Set AND/OR/NOT value
        this.setAndOrNotButton(this.selectedFieldFilterObject.andOrNot);
        this.andOrNotSelectedValue = this.selectedFieldFilterObject.andOrNot;

        // Set Include/Exclude Radio button
        this.$.IncludeExclude.selected = fieldItem.includeExclude;

        // Show/Hide AND/OR/NOT
        if (event.model && event.model.index === 0) {
          this.hideAndOrNot = true;
        } else {
          if (this.customFilters.length) {
            this.hideAndOrNot = false;
          } else {
            this.hideAndOrNot = true;
          }
        }

        this.$.AddFilterDialog.open();
      },

      // Select Field dropdown changed
      fieldSelected: function(event) {

        var type = event.target.selectedItem.getAttribute('type');

        this.selectedFieldFilterObject = JSON.parse(event.target.selectedItem.getAttribute('value'));

        this.$.PlaceHolderFieldValueInput.hidden = true;

        // Hide all types of Filter Value fields
        this.$.AddFilterDialog.querySelectorAll('.filter-type').forEach(function($filterType) {
          $filterType.hidden = true;
        });

        // If a Date/Time field
        if (type === 'gte' || type === 'lte') {
          this.disableFilterButtons(true);
          this.hideDateTimeSelection(false);
          this.$.FieldValueDatePicker.hidden = false;

        // If Text/Dropdown field
        } else {

          if (type === 'select') {
            this.$.FieldValueSelect.hidden = false;
          } else if (type === 'regex') {
            this.$.FieldValueInput.hidden = false;
          }

          this.disableFilterButtons(false);
          this.hideDateTimeSelection(true);
        }

        this.$.AddField.invalid = false;
      },

      // Show/Hide Date/Time before/after radiobuttons
      hideDateTimeSelection: function(hide) {

        if (hide) {
          this.$.IncludeExclude.classList.add('include-exclude--hidden');
        } else {
          this.$.IncludeExclude.classList.remove('include-exclude--hidden');
        }
      },

      // Deselect selected item in field dropdown
      deselectField: function(dropdown) {
        dropdown.selected = undefined;
      },

      // Reset Add filter Dialog form
      addFilterCancelled: function() {
        this.deselectField(this.$.AddFieldList);
        this.$.IncludeExclude.selected = 'include';
        this.setAndOrNotButton('and');

        // Hide all types of Filter Value fields
        this.$.AddFilterDialog.querySelectorAll('.filter-type').forEach(function($filterType) {
          $filterType.hidden = true;
        });

        // Show Placeholder input again
        this.$.PlaceHolderFieldValueInput.hidden = false;

        this.hideDateTimeSelection(true);
      },

      // Check filter to be added is valid
      filterValidate: function() {

        var valid = true;

        // If no data field has been selected
        if (!this.$.AddFieldList.selectedItem) {
          valid = false;
          this.invalidFilterMessage = 'Please select a field to search on.';
          this.$.AddField.invalid = true;
        }

        return valid;
      },

      // Global Search Performed
      globalSearchChanged: function() {

        var filterObject = {
          collectionName: app.config.EventsCollection.name,
          filter: 'global',
          value: this.$.GlobalSearch.value
        };

        this.queryBuilderActions.queryFiltersChanged(filterObject, 'update');
      },

      // Add a filter and pass filters Object via 'queryFiltersChanged' action
      filterAdded: function() {

        // If filter to be added is valid
        if (this.filterValidate()) {

          var item = JSON.parse(this.$.AddFieldList.selectedItem.getAttribute('value'));

          var filterObject = {
            collectionName: app.config.EventsCollection.name,
            fieldName: item.name,
            filter: item.filter,
            filterValues: item.filterValues,
            includeExclude: this.$.IncludeExclude.selected,
            andOrNot: this.andOrNotSelectedValue,
            value: this.getFilterValue(item)
          };

          this.$.AddFilterDialog.close();

          this.addFilterCancelled();

          this.queryBuilderActions.queryFiltersChanged(filterObject, 'add');
        }
      },

      // Edit a filter and pass filters Object via 'queryFiltersChanged' action
      filterEdited: function() {

        // If filter to be added is valid
        if (this.filterValidate()) {

          var item = JSON.parse(this.$.AddFieldList.selectedItem.getAttribute('value'));

          var filterObject = this.selectedFieldFilterObject;
          filterObject.value = this.getFilterValue(item);
          filterObject.andOrNot = this.andOrNotSelectedValue;
          filterObject.includeExclude = this.$.IncludeExclude.selected;

          this.$.AddFilterDialog.close();

          this.addFilterCancelled();

          this.queryBuilderActions.queryFiltersChanged(filterObject, 'update');
        }
      },

      // Get a value of a filter from the relevany input type
      getFilterValue: function(filterItem) {

        var value = '';

        if (filterItem.filter === 'regex') {
          value = this.$.FieldValueInput.value;
        } else if (filterItem.filter === 'select') {
          value = this.$.FieldValueListBox.selected || '';
        } else if (filterItem.filter === 'gte' || filterItem.filter === 'lte') {
          value = this.$.FieldValueDatePicker.dateTime;
        }

        return value;
      },

      // CALLED IN TEMPLATE TO HIDE NON RELEVANT FILTER ELEMENTS
      showFilterType: function(elementType, filterType) {

        if (elementType === 'date') {

          if (filterType === 'lte' || filterType === 'gte') {
            return true;
          }
        } else {

          if (elementType === filterType) {
            return true;
          }
        }
        return false;
      },

      // CALLED IN TEMPLATE TO HIDE NON RELEVANT INCLUDE/EXCLUDE FILTER MESSAGES
      hideIncludeFilter: function(item) {

        if (item.includeExclude === 'include') {
          if (item.filter === 'gte') {
            return false;
          } else if (item.filter === 'lte') {
            return true;
          }
        } else if (item.includeExclude === 'exclude') {
          if (item.filter === 'gte') {
            return true;
          } else if (item.filter === 'lte') {
            return false;
          }
        }
      },

      // CALLED IN TEMPLATE TO HIDE NON RELEVANT INCLUDE/EXCLUDE FILTER MESSAGES
      hideExcludeFilter: function(item) {

        if (item.includeExclude === 'include') {
          if (item.filter === 'lte') {
            return false;
          } else if (item.filter === 'gte') {
            return true;
          }
        } else if (item.includeExclude === 'exclude') {
          if (item.filter === 'gte') {
            return false;
          } else if (item.filter === 'lte') {
            return true;
          }
        }
      },

      // Remove filter from collection
      removeFilter: function(event) {

        var filterObject;

        if (event.currentTarget.getAttribute('last-filter')) {
          filterObject = this.lastFilter;
        } else {
          filterObject = JSON.parse(event.currentTarget.dataset.filter);
        }

        this.queryBuilderActions.queryFiltersChanged(filterObject, 'remove');
      },

      // Get date for date picker
      getFilterDateTime: function(value) {

        if (!value || value === '1900-01-01 00:00:00') {
          return '1900-01-01 00:00:00';
        } else if (value === '2100-12-31 00:00:00') {
          return '2100-12-31 00:00:00';
        } else {
          return moment(value).format('h:mm:ss a on Do MMMM YYYY');
        }
      },

      // Get date for date picker
      getFilterDate: function(value) {

        if (!value || value === '1900-01-01 00:00:00') {
          return '1900-01-01';
        } else if (value === '2100-12-31 00:00:00') {
          return '2100-12-31';
        } else {
          return value.split(' ')[0];
        }
      },

      // Get time for date picker
      getFilterTime: function(value) {

        if (!value || value === '1900-01-01 00:00:00' || value === '2100-12-31 00:00:00') {
          return '00:00:00';
        } else {
          return value.split(' ')[1];
        }
        if (value) {
          return value.split(' ')[1];
        } else {
          return '00:00:00';
        }
      },

      // Show the save presentation card.
      savePresentation: function() {

        this.savePackageCardOpen = true;

        // run slide-up-animation
        this.$.SavePackageOverlay.classList.add('save-package-overlay--showing');
        this.$.SavePackage.classList.add('save-package--showing');
        this.playAnimation('entry');
      },

      // Close the save package card
      closeCard: function() {

        this.savePackageCardOpen = false;

        // run slide-down-animation
        this.$.SavePackageOverlay.classList.remove('save-package-overlay--showing');
        this.playAnimation('exit');
      },

      // Listener when animation finishes
      onSlideAnimationFinish: function() {

        if (!this.savePackageCardOpen) {
          this.$.SavePackage.classList.remove('save-package--showing');
        }
      },

      // Fired from epe-save-package element
      showDialog: function(event) {

        event.preventDefault();
        this.fire('show-dialog', {
          type: event.detail.type,
          presentationName: event.detail.presentationName,
          presentationState: event.detail.presentationState
        });
      },

      // Set state of hideSaveButton depending on presentation state and whether in online mode or not
      manageSaveButton: function(presentationState) {

        if (presentationMode === 'offline' || presentationState === 'viewingLocked') {
          this.hideSaveButton = true;
        } else {
          this.hideSaveButton = false;
        }
      },

      // Set state of message depending on presentation state
      manageSaveMessage: function(presentationState) {

        if (presentationState === 'viewingLocked') {
          this.hideNoSaveMessage = false;
        } else {
          this.hideNoSaveMessage = true;
        }
      },

      // Method to meet requirement that Full Name should display what is specified in config file
      getHeadingName: function(headingName, showCharLimitMessage) {

        var collection;
        var charLimitMessage = '';

        if (!headingName) {
          return;
        }

        if (showCharLimitMessage) {
          charLimitMessage = ' (min 3 chars)';
        }

        switch (this.selectedDataType) {
          case this.config.EventsCollection.name:
            collection = this.config.EventsCollection;
            break;
          case this.config.PlacesCollection.name:
            collection = this.config.PlacesCollection;
            break;
          case this.config.PeopleCollection.name:
            collection = this.config.PeopleCollection;
            break;
          case this.config.SourcesCollection.name:
            collection = this.config.SourcesCollection;
            break;
          default:
            return headingName;
        }

        collection.fields.forEach(function(field) {

          if (field.name === headingName && field.displayName) {
            headingName = field.displayName;
            return;
          }
        });

        return headingName + charLimitMessage;
      },

      // Fire event that we are syncing DB
      syncingDB: function() {
        this.fire('syncing-db');
      },

      // When User selects whether filter is AND, OR or NOT
      andOrNotSelected: function(event) {

        var $andOrNotButtons = this.$.AndOrNot.querySelectorAll('.and-or-not__button');

        $andOrNotButtons.forEach(function($button) {
          $button.active = false;
        });

        this.andOrNotSelectedValue = event.target.getAttribute('and-or-not');
        event.target.active = true;
      },

      // Enable/Disable the AND/OR/NOT buttons
      disableFilterButtons: function(disable) {

        var $andOrNotButtons = this.$.AndOrNot.querySelectorAll('.and-or-not__button');

        if (disable) {
          $andOrNotButtons.forEach(function($button) {
            $button.disabled = true;
            $button.active = false;
          });
        } else {
          this.setAndOrNotButton('and');
        }
      },

      // Set default AND Button
      setAndOrNotButton: function(type) {

        var $andOrNotButtons = this.$.AndOrNot.querySelectorAll('.and-or-not__button');

        $andOrNotButtons.forEach(function($button) {
          $button.disabled = false;
          $button.active = false;
        });

        // Set passed in type to active
        switch(type) {
          case 'and':
            this.$.And.active = true;
            break;
          case 'or':
            this.$.Or.active = true;
            break;
          case 'not':
            this.$.Not.active = true;
            break;
          default:
            this.$.And.active = true;
        }
      },

      // For display purposes need to group filters into dates, mainQuery and lastFilter groups
      createFilterGroups: function(queryBuilderStore) {

        var dateFiltersArray = queryBuilderStore.queryObject.filters.filter(function(filterObject) {
          return filterObject.filter === 'lte' || filterObject.filter === 'gte';
        });

        var customFiltersArray = queryBuilderStore.queryObject.filters.filter(function(filterObject) {
          return filterObject.filter === 'regex' || filterObject.filter === 'select';
        });

        // Set Custom Filters - Need to set array to empty so observable will pick up change to customFilters array
        this.customFilters = [];

        // Set Date Filters - Need to set array to empty so observable will pick up change to dateFilters array
        this.dateFilters = [];

        //Assign Global filter
        this.globalFilterValue = queryBuilderStore.queryObject.filters.filter(function(filterObject) {
          return filterObject.filter === 'global';
        })[0].value;

        if (this.globalFilterValue) {
          this.hideGlobalFilter = false;
        } else {
          this.hideGlobalFilter = true;
        }

        // Assign Custom Filters

        // If Removing last filter
        if (!customFiltersArray.length) {
           this.lastFilter = null;
           this.setLastFilterValues();
        }

        customFiltersArray.forEach(function(filterObject, index) {

          // Add last filter to lastFilter array
          if (index === customFiltersArray.length - 1) {
            this.lastFilter = filterObject;
            this.setLastFilterValues();
            return;
          } else {
            this.push('customFilters', filterObject);
          }
        }.bind(this));

        // Assign Date filters
        this.dateFilters = dateFiltersArray;

        // Whether to show number of results
        this.showHideResultsNumber();

        // Manually stamp array to template as I can't seem to grasp how polymer updates repeat templates automatically
        this.$.DateFiltersTemplate.items = [];
        this.$.FiltersTemplate.items = [];

        this.async(function() {
          this.$.FiltersTemplate.items = this.customFilters;
          this.$.DateFiltersTemplate.items = this.dateFilters;
        });
      },

      // Whether to show number of results
      showHideResultsNumber: function() {

        if (this.lastFilter || this.dateFilters.length || this.globalFilterValue) {
          this.hideFilterResults = false;
        } else {
          this.hideFilterResults = true;
        }
      },

      // Return condition of Last Filter AND/OR/NOT
      getLastFilterCondition: function(lastFilter) {

        if (lastFilter) {

          switch(lastFilter.andOrNot) {
            case 'and':
              return 'AND';
            case 'or':
              return 'OR';
            case 'not':
              return 'BUT NOT';
            default:
              return '';
          }
        }

        return '';
      },

      // Set properties so they update in template if edited
      setLastFilterValues: function() {

        if (this.lastFilter) {
          this.lastFilterField = this.lastFilter.fieldName;
          this.lastFilterValue = this.lastFilter.value;
          this.lastFilterCondition = this.getLastFilterCondition(this.lastFilter);
        }
      },

      // Hide AND/OR/NOT on Main filter Group if first filter
      hideMainFilterCondition: function(index) {

        if (index === 0) {
          return true;
        }
        return false;
      },

      // When a user types in an Add filter text field. If return key, add the filter
      textFieldTyped: function(event) {

        var $addFilterButton = this.$.AddFilterButton;
        var $editFilterButton = this.$.EditFilterButton;

        if (event.keyCode === 13) {

          if (!$addFilterButton.hidden) {
            this.filterAdded();
          } else if (!$editFilterButton.hidden) {
            this.filterEdited();
          }
        }
      }
    });
  })();
</script>
