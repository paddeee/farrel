<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-video-js">
  <link rel="stylesheet" href="../../styles/vendor/videoJS/videoJS.css">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <!-- Create instance -->
    <video id="Video"
           class="video-js vjs-default-skin vjs-big-play-centered"
           controls
           preload="[[preload]]"
           poster="[[poster]]"
           hidden>
      <source src="[[videoSource]]" type='video/mp4'/>
    </video>

    <audio id="Audio"
           class="video-js vjs-default-skin"
           controls
           preload="auto"
           hidden>
      <source src="[[audioSource]]" type='audio/mp3'/>
    </audio>
  </template>
</dom-module>
<script>
  (function() {
    Polymer({
      is: 'epe-video-js',

      properties: {

        fluid: {
          type: Boolean,
          value: true
        },

        preload: {
          type: String,
          value: 'auto'
        },

        poster: {
          type: String,
          value: ''
        },

        mediaObject: {
          type: Object,
          value: null,
          observer: 'setUpMedia'
        },

        mediaType: {
          type: String,
          value: '',
          observer: 'setUpMedia'
        }
      },

      setUpMedia: function() {

        if (this.mediaType) {

          if (this.mediaType === 'video') {
            this.createVideoJS();
          } else if (this.mediaType === 'audio') {
            if (this.audioObject && this.audioObject.Src) {
              this.createAudioJS();
            }
          }
        }
      },

      // Create a clean instance of videoJS on the video element
      createVideoJS: function() {

        if (this.mediaObject) {

          this.videoSource = this.mediaObject.Src;

          this.$.Audio.setAttribute('hidden','');
          //this.$.Audio.parentElement.setAttribute('hidden','');
          this.$.Video.removeAttribute('hidden');

          if (!this.videoJS) {
            this.videoJS = app.videoJS;
          }

          this.videoPlayer = this.videoJS(this.$.Video, {
            fluid: this.fluid
          }).ready(function() {
            console.log("Loaded");
          });

          this.addControlListeners('video');
          this.RemoveControlListeners('video');
        }
      },

      // Create a clean instance of videoJS on the audio element
      createAudioJS: function() {

        this.audioSource = this.mediaObject.Src;

        this.$.Video.setAttribute('hidden','');
        this.$.Audio.removeAttribute('hidden');
        //this.$.Audio.parentElement.removeAttribute('hidden');

        if (!this.videoJS) {
          this.videoJS = app.videoJS;
        }

        this.audioPlayer = this.videoJS(this.$.Audio, {
          fluid: this.fluid
        }).ready(function() {
          console.log("Audio Loaded");
        });

        this.addControlListeners('audio');
        this.RemoveControlListeners('audio');
      },

      // ToDo: get this to work. Needs to reposition video
      fullScreenToggleTapped: function() {

        var $mainScrollHeader;

        this.isFullScreen = !this.isFullScreen;

        if (!this.isFullScreen) {
          $mainScrollHeader = document.querySelector('#MainScrollHeader');
          setTimeout($mainScrollHeader.scroll(128, false), 10000);
        }
      },

      // Set up any listeners required for player controls
      addControlListeners: function(player) {

        var fullScreenToggle;
        var fullScreenAudioToggle;
        var self = this;

        if (player === 'video') {
          fullScreenToggle = this.videoPlayer.controlBar.fullscreenToggle.el();
          this.videoJS.on(fullScreenToggle, 'tap', self.fullScreenToggleTapped);
        } else if (player === 'audio') {
          fullScreenAudioToggle = this.audioPlayer.controlBar.fullscreenToggle.el();
          this.videoJS.on(fullScreenAudioToggle, 'tap', self.fullScreenToggleTapped);
        }
      },

      // Remove Polymer listeners from controls to prevent toggle buttons such as play/pause
      // from firing twice. Polymer is capturing tap events and video.js is automatically adding
      // a click event to control buttons.
      // ToDo: For now going to manually manage removing VideoJS.s 'click' event from relevant elements
      // but may want to look at not passing in 'controls' as an option and building competely custom controls
      RemoveControlListeners: function(player) {

        var playToggleButton;
        var fullScreenToggle;
        var playToggleAudioButton;
        var fullScreenAudioToggle;

        if (player === 'video') {
          playToggleButton = this.videoPlayer.controlBar.playToggle.el();
          fullScreenToggle = this.videoPlayer.controlBar.fullscreenToggle.el();
          this.videoJS.off(playToggleButton, 'click');
          this.videoJS.off(fullScreenToggle, 'click');
        } else if (player === 'audio') {
          playToggleAudioButton = this.audioPlayer.controlBar.playToggle.el();
          fullScreenAudioToggle = this.audioPlayer.controlBar.fullscreenToggle.el();
          this.videoJS.off(playToggleAudioButton, 'click');
          this.videoJS.off(fullScreenAudioToggle, 'click');
        }
      }
    });
  })();
</script>
