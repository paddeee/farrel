<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-import">
  <style>

    :host {
      display: block;
    }

    paper-scroll-header-panel {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background-color: var(--paper-grey-200);

    /* background for toolbar when it is at its full size */
    --paper-scroll-header-panel-full-header: {
       background-color: var(--dark-primary-color);
     };

    /* background for toolbar when it is condensed */
    --paper-scroll-header-panel-condensed-header: {
       background-color: var(--default-primary-color);
     };
    }

    paper-toolbar.tall {
      background-color: transparent;
    }

    paper-toolbar.tall .title {
      font-size: 36px;
      margin-left: 60px;

      -webkit-transform-origin: left center;
      transform-origin: left center;
    }

    .content {
      padding: 8px;
    }

    .radio-container {
      min-width: 230px;
    }

    .parse-import-holder {
      position: relative;
    }

    .parse-import {
      transition: transform 500ms cubic-bezier(0.4, 0, 0.2, 1) 500ms, background-color 500ms cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-transition: -webkit-transform 500ms cubic-bezier(0.4, 0, 0.2, 1) 500ms, background-color 500ms cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-transform: scale(0);
      transform: scale(0);
      -webkit-transform-origin: 50% 50%;
      transform-origin: 50% 50%;
    }

    .parse-import[showing],
    .no-import-selected[showing] {
      -webkit-transform: none;
      transform: none;
    }

    .no-import-selected {
      color: var(--secondary-text-color);
      font-size: 5vw;
      height: 100%;
      position: absolute;
      transition: transform 500ms cubic-bezier(0.4, 0, 0.2, 1) 500ms, background-color 500ms cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-transition: -webkit-transform 500ms cubic-bezier(0.4, 0, 0.2, 1) 500ms, background-color 500ms cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-transform: scale(0);
      transform: scale(0);
      -webkit-transform-origin: 50% 50%;
      transform-origin: 50% 50%;
    }

    .no-import-selected p {
      text-align: center;
    }

    .toast-button-container {
      margin: 16px 0;
    }

    paper-button {
      color: var(--text-primary-color);
    }

    paper-button.affirmitive {
      color: var(--accent-color);
    }

  </style>
  <template>

    <paper-scroll-header-panel condenses keep-condensed-header>

      <!-- Main Toolbar -->
      <paper-toolbar class="tall">
        <paper-icon-button
          id="BackArrow"
          icon="arrow-back"
          on-tap="navigateBack"></paper-icon-button>
        <div class="flex"></div>

        <paper-tooltip for="BackArrow" offset="0">Back</paper-tooltip>

        <!-- Toolbar icons -->
        <paper-icon-button id="ImportButton" icon="file-upload"></paper-icon-button>
        <paper-icon-button id="CreateButton" icon="create"></paper-icon-button>
        <paper-icon-button id="ViewButton" icon="view-list"></paper-icon-button>

        <!-- paper-icon-buttons have an inherent padding that will push the tooltip down. offset undoes it -->
        <paper-tooltip for="ImportButton" offset="0">Import CaseMap File</paper-tooltip>
        <paper-tooltip for="CreateButton" offset="0">Create Package</paper-tooltip>
        <paper-tooltip for="ViewButton" offset="0">View Packages</paper-tooltip>

        <!-- Application name -->
        <div id="MiddleContainer" class="middle middle-container center horizontal layout">
          <div id="SectionName" class="section-name">Import <span>[[params.name]]</span> CaseMap File</div>
        </div>

        <!-- Application sub title -->
        <div id="BottomContainer" class="bottom bottom-container center horizontal layout">
          <div class="bottom-title paper-font-subhead">Special Investigation Task Force</div>
        </div>
      </paper-toolbar>

      <iron-pages attr-for-selected="data-route" selected="{{importRoute}}">

        <!-- Import Parse -->
        <section data-route="import-parse">
          <div class="content layout horizontal">

            <!-- File Import Selector -->
            <div class="flex-1 relative radio-container">
              <paper-material class="card fit layout vertical">
                <paper-radio-group selected="{{importedFileType}}">
                  <paper-radio-button name="Events">Events</paper-radio-button>
                  <paper-radio-button name="People">People</paper-radio-button>
                  <paper-radio-button name="Places">Places</paper-radio-button>
                  <paper-radio-button name="Radio1">Radio1</paper-radio-button>
                  <paper-radio-button name="Radio2">Radio2</paper-radio-button>
                  <paper-radio-button name="Radio3">Radio3</paper-radio-button>
                </paper-radio-group>
              </paper-material>
            </div>

            <!-- Drag & Drop CSV Import -->
            <div class="flex-3  parse-import-holder">
              <div class="no-import-selected horizontal layout center"
                   showing$="[[!isFileTypeSelected]]">
                <p>Please choose a type of CaseMap File to Import.</p>
              </div>

              <paper-material
                class="card parse-import"
                elevation="1"
                showing$="[[isFileTypeSelected]]">

                <epe-parse-spreadsheet
                  import-actions="[[importActions]]"
                  import-store="[[importStore]]"
                  packaged-app="[[packagedApp]]"
                  csv-type="[[importedFileType]]"
                  csv-parser="[[csvParser]]"
                  on-import-finished="importFinishedHandler">
                </epe-parse-spreadsheet>
              </paper-material>
            </div>
          </div>
        </section>

        <!-- Import Check -->
        <section data-route="import-check">

          <!-- Navigation Tabs -->
          <paper-tabs attr-for-selected="name" selected="{{params.name}}">
            <paper-tab name="Events" link>
              <a href="/import-check/Events" class="horizontal center-center layout">EVENTS</a>
            </paper-tab>
            <paper-tab name="People" link>
              <a href="/import-check/People" class="horizontal center-center layout">PEOPLE</a>
            </paper-tab>
            <paper-tab name="Places" link>
              <a href="/import-check/Places" class="horizontal center-center layout">PLACES</a>
            </paper-tab>
            <paper-tab name="Radio1" link>
              <a href="/import-check/Radio1" class="horizontal center-center layout">RADIO 1</a>
            </paper-tab>
            <paper-tab name="Radio2" link>
              <a href="/import-check/Radio2" class="horizontal center-center layout">RADIO 2</a>
            </paper-tab>
            <paper-tab name="Radio3" link>
              <a href="/import-check/Radio3" class="horizontal center-center layout">RADIO 3</a>
            </paper-tab>
          </paper-tabs>

          <!-- Main Content -->
          <div class="content">
            <paper-material class="card" elevation="1">
              <epe-import-check
                imported-file-type="[[params.name]]"></epe-import-check>
            </paper-material>
          </div>
        </section>
      </iron-pages>
    </paper-scroll-header-panel>

    <!-- Import Notifications -->
    <paper-toast id="ImportToast" duration="100000">
      <h2><span>[[importFinished.title]]</span></h2>
      <div>
        <div>[[importFinished.message]]</div>
        <div>View Imported CaseMap File?</div>
        <div class="toast-button-container layout horizontal">
          <paper-button tabindex="0" class="flex custom" on-tap="closeToast">
            <iron-icon icon="clear"></iron-icon>NO
          </paper-button>
          <paper-button tabindex="0" class="affirmitive flex custom" on-tap="navigateToImportCheck">
            <iron-icon icon="check"></iron-icon>YES
          </paper-button>
        </div>
      </div>
    </paper-toast>

  </template>
</dom-module>
<script>

(function() {
  Polymer({
    is: 'epe-import',

    properties: {

      importedFileType: {
        type: String,
        observer: 'fileTypeChanged',
        value: ''
      },

      isFileTypeSelected: {
        type: 'Boolean',
        value: false
      },

      lastFileTypeImported: {
        type: String
      },

      importFinished: {
        type: Object,
        value: null
      }
    },

    ready: function() {

      addEventListener('paper-header-transform', function(e) {
        var sectionName = this.$.SectionName;
        var middleContainer = this.$.MiddleContainer;
        var bottomContainer = this.$.BottomContainer;
        var detail = e.detail;
        var heightDiff = detail.height - detail.condensedHeight;
        var yRatio = Math.min(1, detail.y / heightDiff);
        var maxMiddleScale = 0.50;  // appName max size when condensed. The smaller the number the smaller the condensed size.
        var scaleMiddle = Math.max(maxMiddleScale, (heightDiff - detail.y) / (heightDiff / (1-maxMiddleScale))  + maxMiddleScale);
        var scaleBottom = 1 - yRatio;

        // Move/translate middleContainer
        Polymer.Base.transform('translate3d(0,' + yRatio * 100 + '%,0)', middleContainer);

        // Scale bottomContainer and bottom sub title to nothing and back
        Polymer.Base.transform('scale(' + scaleBottom + ') translateZ(0)', bottomContainer);

        // Scale middleContainer appName
        Polymer.Base.transform('scale(' + scaleMiddle + ') translateZ(0)', sectionName);
      }.bind(this));
    },

    // Called from the observer on the importedFileType which will change when radio buttons are selected
    fileTypeChanged: function() {
      if (this.importedFileType) {
        this.isFileTypeSelected = true;
      }

      return false;
    },

    // TRIGGERED BY EVENT FIRED ON CHILD ELEMENT: Import completed
    importFinishedHandler: function(importData) {

      this.importFinished = importData.detail;

      // Delay by a second as the spinner hiding is delayed by a second
      this.async(function() {

        // Reset Page
        this.isFileTypeSelected = false;
        this.lastFileTypeImported = this.importedFileType;
        this.importedFileType = '';

        // Show dialog message
        this.openToast();
      }, 1000);
    },

    // Open the Toast
    openToast: function() {
      this.$.ImportToast.show();
    },

    // Close the Toast
    closeToast: function() {
      this.$.ImportToast.hide();
    },

    // Navigate to the import check view
    navigateToImportCheck: function() {
      page('/import-check/' + this.lastFileTypeImported);
      this.closeToast();
    },

    // Navigate back
    navigateBack: function() {
      history.back();
    }
  });
})();
</script>
