<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-import">
  <style>

    :host {
      display: block;
    }

    .main-content {
      height: 100%;
    }

    .import-area {
      padding: 8px;
    }

    .import-check {
      background-color: var(--text-primary-color);
      height: 100%;
    }

    .import-status-container {
      min-width: 230px;
    }

    .import-status-heading {
      font-size: 2vw;
      font-weight: bold;
      margin: 0 0 2vh;
    }

    .import-status-files {
      font-size: 1.2vw;
      margin: 0.5vh 0;
    }

    .parse-import-holder {
      position: relative;
    }

    .no-import-selected {
      color: var(--secondary-text-color);
      font-size: 5vw;
      height: 100%;
      position: absolute;
    }

    .no-import-selected p {
      text-align: center;
    }

    .toast-button-container {
      margin: 16px 0;
    }

    paper-button {
      color: var(--text-primary-color);
    }

    paper-button.affirmitive {
      color: var(--accent-color);
    }

    .imported-icon {
      font-size: 1.4vh;
    }

  </style>
  <template>

    <!-- Main Content -->
    <iron-pages
      class="main-content"
      attr-for-selected="data-route"
      selected="{{importRoute}}">

      <!-- Import Parse -->
      <section data-route="import" class="import-area layout horizontal">

        <!-- Drag & Drop CSV Import -->
        <div class="flex-3 parse-import-holder">

          <paper-material
            class="card parse-import"
            elevation="1">

            <epe-parse-spreadsheet
              import-actions="[[importActions]]"
              import-store="[[importStore]]"
              packaged-app="[[packagedApp]]"
              csv-type="[[importedFileType]]"
              csv-parser="[[csvParser]]"
              on-file-imported="fileImported"
              on-import-failed="importFailedHandler"
              on-import-finished="importFinishedHandler">
            </epe-parse-spreadsheet>
          </paper-material>
        </div>

        <!-- File Import Selector -->
        <div class="flex-1 relative import-status-container">
          <paper-material class="card fit">
            <div class="import-status-heading">Import Status</div>
            <div class="import-status-files"
                 hidden="[[importing]]">Awaiting import..</div>
            <template id="FileImportTemplate"
                      is="dom-repeat"
                      items="[[importedFiles]]">
              <div class="import-status-files flex layout horizontal center"
                   hidden="[[!importing]]">
                <span class="flex">[[item.name]]</span>
                <iron-icon
                  class="imported-icon"
                  icon="check"></iron-icon></div>
            </template>
          </paper-material>
        </div>
      </section>
    </iron-pages>

    <!-- Import Notifications -->
    <paper-toast id="ImportToast" duration="10000">
      <h2><span>[[importFinished.title]]</span></h2>
      <div>
        <div>[[importFinished.message]]</div>
        <div class="toast-button-container layout horizontal">
          <paper-button tabindex="0" class="affirmitive flex custom" on-tap="closeToast">
            <iron-icon icon="check"></iron-icon>OK
          </paper-button>
        </div>
      </div>
    </paper-toast>

    <paper-toast id="ImportFailedToast" duration="10000">
      <h2><span>[[importFailed.title]]</span></h2>
      <div>
        <div>[[importFailed.message]]</div>
        <div class="toast-button-container layout horizontal">
          <paper-button tabindex="0" class="affirmitive flex custom" on-tap="closeToast">
            <iron-icon icon="check"></iron-icon>OK
          </paper-button>
        </div>
      </div>
    </paper-toast>

  </template>
</dom-module>
<script>

(function() {
  Polymer({
    is: 'epe-import',

    properties: {

      importing: {
        type: Boolean,
        value: false
      },

      importFinished: {
        type: Object,
        value: null
      },

      importFailed: {
        type: Object,
        value: null
      },

      importedFiles: {
        type: Array,
        value: []
      }
    },

    // TRIGGERED BY EVENT FIRED ON CHILD ELEMENT: File Imported
    fileImported: function(importData) {

      var fileObject = {
        name: importData.detail.message
      };

      this.importing = true;

      // If an import has just already been performed
      if (this.importFinished) {
        this.splice('importedFiles', 0, this.importedFiles.length);
        this.importFinished = null;
      }

      this.push('importedFiles', fileObject);
    },

    // TRIGGERED BY EVENT FIRED ON CHILD ELEMENT: Import failed
    importFailedHandler: function(importData) {

      this.importFailed = importData.detail;

      this.importing = false;

      // Delay by a second as the spinner hiding is delayed by a second
      this.async(function() {

        // Show dialog message
        this.$.ImportFailedToast.show();
      }, 1000);
    },

    // TRIGGERED BY EVENT FIRED ON CHILD ELEMENT: Import completed
    importFinishedHandler: function(importData) {

      this.importFinished = importData.detail;

      // Delay by a second as the spinner hiding is delayed by a second
      this.async(function() {

        // Show dialog message
        this.openToast();
      }, 1000);
    },

    // Open the Toast
    openToast: function() {
      this.$.ImportToast.show();
    },

    // Close the Toast
    closeToast: function() {
      this.$.ImportToast.hide();
    }
  });
})();
</script>
