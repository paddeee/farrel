<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-image-viewer">
  <style>
    :host {
      display: block;
    }

    .image__container {
      overflow: auto;
      position: absolute;
      top: 4px;
      right: 0;
      bottom: 7vh;
      left: 0;
    }

    .image__content {
      box-sizing: border-box;
      height: 80vh;
      width: 100vw;
      padding: 4vh 4vw;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    paper-material {
      background-color: var(--primary-background-color);
      height: 100%;
      width: 100%;
      transition: height 0.5s ease;
      transition: width 0.5s ease;
    }

    .loading-mask {
      background-color: var(--primary-background-color);
      height: 100%;
    }

    .image-name {
      padding: 0 2vw 2vh;
      font-size: 2.5vh;
      color: var(--text-primary-color);
    }

    .image-description {
      padding: 2vh 2vw;
      font-size: 1.8vh;
      color: var(--text-primary-color);
    }

    .image {
      height: 100%;
      width: 100%;
    }

    .image__footer {
      background: rgb(55, 64, 70);
      color: var(--text-primary-color);
      padding: 8px 4vw;
      font-size: 2vh;
      height: 5vh;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
    }
  </style>
  <template>

    <!-- Image Container -->
    <div id="ImageContainer"
         class="image__container layout vertical center center-justified">

      <!-- Image Content -->
      <div id="ImageContent"
           class="image__content layout vertical center flex">

        <!-- Headline -->
        <div class="image-name">[[imageName]]</div>

        <!-- Image Card -->
        <paper-material id="ImageCard" elevation="5" on-track="imageDragged">

          <!-- Loading Mask -->
          <div id="LoadingMask" class="loading-mask layout horizontal center center-justified">
            <paper-spinner alt="Loading Media" active$="[[loadingImage]]"></paper-spinner>
          </div>

          <!-- Annotation Layer -->
          <epe-annotations
            id="ImageAnnotations"
            annotation-type="image"
            annotation-height="{{annotationHeight}}"
            annotation-width="{{annotationWidth}}"
            zoomLevel="{{zoomLevel}}">

              <!-- Image -->
              <img id="Image"
                   class="image"
                   alt="[[headline]]"
                   src="[[imageSource]]"
                   hidden
                   drag-mode$="[[dragMode]]"/>
          </epe-annotations>

        </paper-material>

        <!-- Description -->
        <div class="image-description">[[imageDescription]]</div>

      </div>

      <!-- Image Footer -->
      <div class="image__footer relative horizontal layout center">
        <div class="image_button-holder flex">
          <paper-icon-button id="ZoomOut" icon="zoom-out" on-tap="zoomOut" disabled></paper-icon-button>
          <paper-icon-button id="ZoomIn" icon="zoom-in" on-tap="zoomIn"></paper-icon-button>
        </div>
      </div>

    </div>
  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: 'epe-image-viewer',

    properties: {

      loadingImage: {
        type: Boolean,
        value: true
      },

      imageObject: {
        type: Object,
        value: null,
        observer: 'setUpImage'
      },

      annotationHeight: {
        type: Number,
        value: 0
      },

      annotationWidth: {
        type: Number,
        value: 0
      },

      zoomLevel: {
        type: Number,
        value: 1
      },

      dragMode: {
        type: Boolean,
        value: false
      },

      imageX: {
        type: Number,
        value: 0
      },

      imageY: {
        type: Number,
        value: 0
      }
    },

    ready: function() {
      window.addEventListener('resize', this.resizeImageContainer.bind(this));
    },

    // Set source on image element
    setUpImage: function() {

      if (this.imageObject && this.imageObject.Src) {

        // Set image titles
        this.imageName = this.imageObject.Headline;
        this.imageDescription = this.imageObject.Description;

        // Render the image and hide spinner
        this.renderImage();
      }
    },

    // Show image and hide spinner when an image has loaded
    renderImage: function() {

      var $image = this.$.Image;

      $image.addEventListener('load', function () {

        // Resize the paper-material element to size of the image
        this.resizeImageContainer($image.naturalWidth, $image.naturalHeight);

        this.async(function() {
          this.loadingImage = false;
          $image.removeAttribute('hidden');
          this.$.LoadingMask.hidden = true;
        }, 500);
      }.bind(this));

      // Set the src of the image
      this.imageSource = this.imageObject.Src;
    },

    // Resize the image container to the size of the image
    resizeImageContainer: function() {

      var $image;
      var bottom;
      var $containerWidth;
      var $containerHeight;
      var imageRatio;
      var containerPaddingTop;
      var containerPaddingRight;
      var containerPaddingBottom;
      var containerPaddingLeft;
      var actualContainerWidth;
      var actualContainerHeight;

      // Resize event can be triggered by other unrelated parts of the application such as Leaflet Map or iron-resize
      // If this method hasn't been called by the image load or event or a window resize event, do nothing
      if ((event.srcElement.document && event.srcElement.location) || event.srcElement === this.$.Image) {

        if (!this.$ || !this.$.Image || !this.$.Image.height) {
          return;
        }

        if (this.editState === this.presentationState) {

          $image = this.$.Image;
          $containerWidth = $image.naturalWidth;
          $containerHeight = $image.naturalHeight;
          imageRatio = $containerWidth / $containerHeight;

          // Take footer into account
          bottom = parseInt(getComputedStyle(this.$.ImageContainer).getPropertyValue("bottom"), 10);

          // Container values
          containerPaddingTop = parseInt(getComputedStyle(this.$.ImageContent).getPropertyValue("padding-top"), 10);
          containerPaddingRight = parseInt(getComputedStyle(this.$.ImageContent).getPropertyValue("padding-right"), 10);
          containerPaddingBottom = parseInt(getComputedStyle(this.$.ImageContent).getPropertyValue("padding-bottom"), 10);
          containerPaddingLeft = parseInt(getComputedStyle(this.$.ImageContent).getPropertyValue("padding-left"), 10);
          actualContainerWidth = this.$.ImageContent.clientWidth - containerPaddingLeft - containerPaddingRight;
          actualContainerHeight = this.$.ImageContent.clientHeight - containerPaddingTop - containerPaddingBottom - bottom;

          // Landscape Image
          if (imageRatio >= 1) {

            // If the image width is wider than the container, set it to the size of the container
            // and the height to the container width * imageRatio
            if ($containerWidth > actualContainerWidth) {
              $containerWidth = actualContainerWidth;
              $containerHeight = $containerWidth / imageRatio;
            }

            // If the image height is taller than the container, set it to the size of the container
            // and the width to the container height * imageRatio
            if ($containerHeight > actualContainerHeight) {
              $containerHeight = actualContainerHeight;
              $containerWidth = $containerHeight * imageRatio;
            }

          // Portrait Image
          } else {

            // If the image height is taller than the container, set it to the size of the container
            // and the width to the container height * imageRatio
            if ($containerHeight > actualContainerHeight) {
              $containerHeight = actualContainerHeight;
              $containerWidth = $containerHeight * imageRatio;
            }
          }

          this.$.ImageCard.style.height = Math.round($containerHeight) + 'px';
          this.$.ImageCard.style.width = Math.round($containerWidth) + 'px';

          // Set height that can be passed up to annotation triggering a resize of the canvas
          this.annotationHeight = $containerHeight;
          this.annotationWidth = $containerWidth;
        }
      }
    },

    // Zoom Out of Image
    zoomOut: function() {

      var $image = this.$.Image;

      this.dragMode = true;

      // Change canvas cursor
      this.$.ImageAnnotations.canvas.defaultCursor = '-webkit-grab';

      this.zoomLevel = parseFloat((this.zoomLevel / 1.25).toFixed(2));

      if (this.zoomLevel >= 1) {

        // Set CSS transform on image to scale down
        $image.style.transformOrigin = this.imageX + ' ' + this.imageY;
        $image.style.transform = 'scale(' + this.zoomLevel + ', ' + this.zoomLevel + ')';

        // Fire event to let annotaions element know to zoom in
        this.$.ImageAnnotations.zoom(this.zoomLevel);

        // Set button states
        this.$.ZoomIn.disabled = false;
        this.$.ZoomOut.disabled = false;

      // Zoom level has gone below 1 so reset to 1
      } else {
        this.zoomLevel = 1;
      }

      // Set button states
      if (this.zoomLevel === 1) {
        this.$.ZoomOut.disabled = true;
      } else {
        this.$.ZoomOut.disabled = false;
      }
    },

    // Zoom In to Image
    zoomIn: function() {

      var $image = this.$.Image;

      this.dragMode = true;

      // Change canvas cursor
      this.$.ImageAnnotations.canvas.defaultCursor = '-webkit-grab';

      this.zoomLevel = parseFloat((this.zoomLevel * 1.25).toFixed(2));

      if (this.zoomLevel < 10) {

        // Set CSS transform on image to scale up
        $image.style.transformOrigin = this.imageX + ' ' + this.imageY;
        $image.style.transform = 'scale(' + this.zoomLevel + ', ' + this.zoomLevel + ')';

        // Fire event to let annotaions element know to zoom in
        this.$.ImageAnnotations.zoom(this.zoomLevel);

        // Set button states
        this.$.ZoomOut.disabled = false;
        this.$.ZoomIn.disabled = false;

      } else {
        this.$.ZoomIn.disabled = true;
      }
    },

    // FIRED FROM PAPER-MATERIAL ELEMENT WHEN DRAG ACTION OCCURS
    imageDragged: function(event) {

      var $image = this.$.Image;
      var imageCoords;
      var $canvasContainer = this.querySelector('.canvas-container');

      if (this.dragMode) {

        switch(event.detail.state) {

          case 'start':

            // Change canvas cursor
            this.$.ImageAnnotations.canvas.defaultCursor = '-webkit-grabbing';

            break;

          case 'track':

            // Set x and y image coordinates and scale to translate image to on
            imageCoords = this.getImageCoords();
            $image.style.transform = 'translate(' + imageCoords.imageX + 'px, ' + imageCoords.imageY + 'px) scale(' + this.zoomLevel + ', ' + this.zoomLevel + ')';

            // Set x and y coordinates on the canvas container element
            //$canvasContainer.style.transform = 'translate(' + imageCoords.imageX + 'px, ' + imageCoords.imageY + 'px)';
            break;

          case 'end':

            // Set end of drag action x and y image coordinates
            imageCoords = this.getImageCoords();
            this.imageX = imageCoords.imageX;
            this.imageY = imageCoords.imageY;

            // Change canvas cursor
            this.$.ImageAnnotations.canvas.defaultCursor = '-webkit-grab';

            break;
        }
      }
    },

    // Calculate the bounding edges of the image to prevent the user dragging past and return the
    // X and Y coordinates
    getImageCoords: function() {

      var $image = this.$.Image;
      var imageZoomedHeight = $image.height * this.zoomLevel;
      var imageZoomedWidth = $image.width * this.zoomLevel;
      var topBound = 0;
      var rightBound = imageZoomedWidth - $image.width;
      var bottomBound = imageZoomedHeight - $image.height;
      var leftBound = 0;
      var imageX = 0;
      var imageY = 0;

      // If image is within X coordinate bounds
      if (this.imageX + event.detail.dx <= leftBound && this.imageX + event.detail.dx >= -rightBound) {
        imageX = this.imageX + event.detail.dx;
      } else {

        // Dragged past leftBound
        if (this.imageX + event.detail.dx > leftBound) {

          imageX = 0;

          // Dragged past rightBound
        } else if (this.imageX + event.detail.dx < -rightBound) {

          imageX = -rightBound;
        }
      }

      // If image is within Y coordinate bounds
      if (this.imageY + event.detail.dy <= topBound && this.imageY + event.detail.dy >= -bottomBound) {

        imageY = this.imageY + event.detail.dy;

      } else {

        // Dragged past topBound
        if (this.imageY + event.detail.dy > topBound) {

          imageY = 0;

          // Dragged past bottomBound
        } else if (this.imageY + event.detail.dy < -bottomBound) {

          imageY = -bottomBound;
        }
      }

      return {
        imageX: imageX,
        imageY: imageY
      }
    }
  });
})();
</script>
