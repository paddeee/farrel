<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-timeline">

  <link rel="stylesheet" href="../../styles/vendor/timeline/timeline.css">
  <link rel="stylesheet" href="../../styles/vendor/timeline/timeline-override.css">

  <style>

    :host {
      display: block;
    }

    .timeline {
       height: 100%;
     }

    .timeline-controls {
      border-right: 1px solid #D8D8D8;
      height: inherit;
      width: 50px;
    }

    .timeline-controls paper-icon-button {
      height: 32px;
      width: 32px;
    }

  </style>

  <script src="../../scripts/vendor/timeline/timeline.js"></script>

  <template>
    <div class="timeline-container layout horizontal">
      <div class="timeline-controls layout vertical  center center-justified">
        <paper-icon-button id="StartButton"
                           icon="av:fast-rewind"
                           on-tap="goToStart"></paper-icon-button>
        <paper-icon-button id="PreviousButton"
                           disabled
                           icon="arrow-back"
                           on-tap="goToPrevious"></paper-icon-button>
        <paper-icon-button id="NextButton"
                           icon="arrow-forward"
                           on-tap="goToNext"></paper-icon-button>
        <paper-icon-button id="ZoomInButton"
                           icon="zoom-in"
                           on-tap="zoomIn"></paper-icon-button>
        <paper-icon-button id="ZoomOutButton"
                           icon="zoom-out"
                           on-tap="zoomOut"></paper-icon-button>

        <paper-tooltip for="StartButton" position="right">Back To Start</paper-tooltip>
        <paper-tooltip for="PreviousButton" position="right">Previous Event</paper-tooltip>
        <paper-tooltip for="NextButton" position="right">Next Event</paper-tooltip>
        <paper-tooltip for="ZoomInButton" position="right">Zoom In</paper-tooltip>
        <paper-tooltip for="ZoomOutButton" position="right">Zoom Out</paper-tooltip>
      </div>
      <div id='TimeLine' class="timeline"></div>
    </div>
  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: 'epe-timeline',

    properties: {

      timeLine: {
        type: Object
      },

      zoom: {
        type: Number,
        value: 3,
        observer: 'zoomChanged'
      },

      selectedEvent: {
        type: String,
        value: "0",
        observer: 'selectedEventChanged'
      },

      timeLineData: {
        type: Object,
        observer: 'timeLineDataChanged',
        value: {
          "title": {
            "unique_id": "0",
            "text": {
              "headline": "No Selected Events"
            }
          },
          "events": [/*
            {
              "unique_id": "1",
              "start_date": {
                "year": "1600"
              },
              "text": {
                "headline": "The Antikythera",
                "text": "In the year 1900, sponge divers discovered the Antikythera Mechanism, a remarkable mechanical computer used to track the cycles of the solar system dated to as early as 89 B.C. There was no input however. All computations were carried out by the intricate system of clockwork like plates and wheels.."
              }
            },
            {
              "unique_id": "2",
              "start_date": {
                "year": "1642"
              },
              "text": {
                "headline": "Pascal's Calculator",
                "text": "<p>Blaise Pascal invented this calculator to help his father reorganize the French tax system. It could add and subtract in one step and multiply and divide by repetition.</p><p>Input was achieved by spinning the little wheels: inspiration for the iPod click wheel?</p>"
              }
            },
            {
              "unique_id": "3",
              "start_date": {
                "year": "1820"
              },
              "text": {
                "headline": "Thomas Arithometer",
                "text": "This is the first mass-produced calculator that could add, subtract, multiply and divide. Numbers were  input with all of the little knobs and dials and then the handle was twisted to perform the calculation."
              }
            },
            {
              "unique_id": "4",
              "start_date": {
                "year": "1801"
              },
              "text": {
                "headline": "Jacquard Loom",
                "text": "A loom is not a computer. It is the first machine however to use punch-cards as a means of input into a machine. By changing the arrangement of the holes in the card, the loom would weave different patterns. "
              }
            },
            {
              "unique_id": "5",
              "start_date": {
                "year": "1833"
              },
              "text": {
                "headline": "The Analytical Engine",
                "text": "Charles Babbage designed but was never able to produce a working model but it is significant in that it relied upon punched cards for data and programs and would employ a language similar to modern assembly language complete with loops and conditional branching (for the nerds out there)."
              }
            },
            {
              "unique_id": "6",
              "start_date": {
                "year": "1868"
              },
              "text": {
                "headline": "The Typewriter",
                "text": "Again, not a computer but an important step forward in user interfaces. Invented by Christopher Sholes, An American engineer, the typewriter was layed out in the familiar QWERTY style."
              }
            },
            {
              "unique_id": "7",
              "start_date": {
                "year": "1890"
              },
              "text": {
                "headline": "Herman Hollerith",
                "text": "In 1890, Hollerith introduced his tabulating machine to be used in the census. He also later invented a key punch, a machine that punched the holes into cards operated by a keyboard. His company was one of the companies that later merged to form IBM."
              }
            },
            {
              "unique_id": "8",
              "start_date": {
                "year": "1940"
              },
              "text": {
                "headline": "Remote Access Computing",
                "text": "George Stibitz demonstrated the Complex Number Calculator (CNC) at Dartmouth College. The astonishing part was that the CNC was in New York City."
              }
            },
            {
              "unique_id": "9",
              "start_date": {
                "year": "1946"
              },
              "text": {
                "headline": "ENIAC",
                "text": "Weighing 30 tons, and containing over 18,000 vacuum tubes, the ENIAC was the first truly modern computer. It could be programmed for many complex programs and used an early keyboard as its input."
              }
            },
            {
              "unique_id": "10",
              "start_date": {
                "year": "1951"
              },
              "text": {
                "headline": "UNIVAC I",
                "text": "The Universal Automatic Computer I weighed in at 13 tons and sold for over one million dollars. It was the first mass produced computer, selling 46 units. The massive cockpit of a console featured a keyboard"
              }
            },
            {
              "unique_id": "11",
              "start_date": {
                "year": "1964"
              },
              "text": {
                "headline": "Multics",
                "text": "A collaboration between MIT, Bell Laboratories and General Electric created the Multics system. It was a multi-user, time sharing system that spurred along the use of a new interface, a monitor."
              }
            },
            {
              "unique_id": "12",
              "start_date": {
                "year": "1968"
              },
              "text": {
                "headline": "Minicomputer",
                "text": "Data General introduces the Nova Minicomputer which served as an inspiration for Steve Wozniak's design of the Apple I."
              }
            },
            {
              "unique_id": "13",
              "start_date": {
                "month": "12",
                "day": "9",
                "year": "1968"
              },
              "text": {
                "headline": "The Mouse",
                "text": "Douglas C. Engelbart and his team demonstrated an online system featuring a mouse, hypertext and the first graphical user interface, a \"windows\" system. The mouse was encased in a wood body and had only one button."
              }
            },
            {
              "unique_id": "14",
              "start_date": {
                "year": "1974"
              },
              "text": {
                "headline": "Xerox Alto",
                "text": "The Xerox Alto was the first workstation with a built in mouse with three buttons."
              }
            },
            {
              "unique_id": "15",
              "start_date": {
                "year": "1976"
              },
              "text": {
                "headline": "Apple I",
                "text": "Steve Wozniak designed the Apple I, a single-board computer that he and Steve Jobs sold for $500 each. Thus began Apple Inc. and the Personal Computer."
              }
            },
            {
              "unique_id": "16",
              "start_date": {
                "year": "1976"
              },
              "text": {
                "headline": "The Osborne I",
                "text": "Weighing 24 pounds and costing under $2,000, the Osborne I was the first portable computer, although you probably couldn't use it in your lap for too long."
              }
            },
            {
              "unique_id": "17",
              "start_date": {
                "year": "1982"
              },
              "text": {
                "headline": "Windows 1.0",
                "text": "Microsoft unveils what will become the dominant operating system for the next several decades."
              }
            },
            {
              "unique_id": "18",
              "start_date": {
                "year": "1984"
              },
              "text": {
                "headline": "The Macintosh",
                "text": "Apple introduced the Macintosh which was the first commercially successful computer with a mouse and a Graphical User Interface. Apple's Think Different Superbowl commercial also plays this year."
              }
            },
            {
              "unique_id": "19",
              "start_date": {
                "year": "1997"
              },
              "text": {
                "headline": "The Stylus",
                "text": "Personal digital assistants introduce the touch screen with the use of a stylus. Handwriting recognition was hit or miss but some companies developed simplified alphabet input strokes to improve recognition."
              }
            },
            {
              "unique_id": "20",
              "start_date": {
                "month": "10",
                "day": "23",
                "year": "2001"
              },
              "text": {
                "headline": "Continuous Scrolling",
                "text": "The first iPod introduces the wheel as a user interface. It allowed users to continuously scroll through thousands of songs seemlessly. This interface helped Apple dominate the music player business and eventually the music content business through its iTunes ecosystem."
              }
            },
            {
              "unique_id": "21",
              "start_date": {
                "year": "2007"
              },
              "text": {
                "headline": "Multi Touch",
                "text": "Steve Jobs unveils the iPhone and the multi touch interface."
              }
            },
            {
              "unique_id": "22",
              "start_date": {
                "year": "2012"
              },
              "text": {
                "headline": "Speech Recognition",
                "text": "<p>Speech recognition has been tested and improved upon for years in military cockpits in the U.S. France and U.K. In fact, Siri, the speech recognition engine used in the iPhone 4S was developed first by DARPA, the Defense Advanced Research Projects Agency.</p>"
              }
            }*/
          ]
        }
      },

      timeLineOptions: {
        type: Object,
        value: {
          hash_bookmark: false
        }
      }
    },

    ready: function() {

      if (this.timeLineStore) {

        // When the events data is updated, update our grid data
        this.timeLineStore.listen(function(timeLineJSONObject) {

          var previousEvents = this.timeLineData.events;

          this.timeLineData = timeLineJSONObject;

          // If there are selected events
          if (this.timeLineData.events.length) {

            // Keep first and last events up to date
            this.setFirstAndLast();

            // If the TimeLine has not been created
            if (!this.timeLine) {

              // Initialise Timeline
              this.createTimeLine();
            } else {
              this.updateTimeLine(previousEvents);
            }
          }

        }.bind(this));
      }
    },

    // Create a new instance of the timeLine
    createTimeLine: function() {

      // Initialise Timeline
      this.timeLine = new TL.Timeline(this.$.TimeLine, this.timeLineData, this.timeLineOptions);

      this.timeLine.on('change', function(eventData) {
        this.selectedTimeLineEventChanged(eventData);
      }.bind(this));

      this.fire('timeline-events-changed', {
        showControls: true
      });
    },

    // Remove all data and then add each record
    updateTimeLine: function(previousEvents) {

      var allEventIds;
      var previousEventIds;
      var eventIdsToAdd;
      var eventIdsToRemove;

      allEventIds = _.map(this.timeLineData.events, 'unique_id');
      previousEventIds = _.map(previousEvents, 'unique_id');

      // If events have been added
      if (this.timeLineData.events.length > previousEvents.length) {

        // Get array of new event ids
        eventIdsToAdd = _.difference(allEventIds, previousEventIds);

        this.timeLineData.events.forEach(function(eventObject) {

          if (_.includes(eventIdsToAdd, eventObject.unique_id)) {
            this.timeLine.add(eventObject);
          }
        }.bind(this));

      // If events have been removed
      } else if (previousEvents.length > this.timeLineData.events.length) {

        // Get array of removed event ids
        eventIdsToRemove = _.difference(previousEventIds, allEventIds);

        previousEvents.forEach(function(eventObject) {

          if (_.includes(eventIdsToRemove, eventObject.unique_id)) {
            this.timeLine.removeId(eventObject.unique_id);
          }
        }.bind(this));
      }
    },

    // Timeline seems a bit buggy. Having to do hacky things like zoom twice to make sure the time axis appear
    initialiseTimelineUI: function() {

      if (this.timeLine) {
        this.timeLine.setZoom(this.zoom + 3);
        this.timeLine.setZoom(this.zoom);
        this.timeLine.updateDisplay();
      }
    },

    // Got to start of TimeLine
    goToStart: function() {
      this.selectedEvent = "0";
      this.$.PreviousButton.disabled = true;
      this.timeLine.goToStart();
    },

    // Got to previous event
    goToPrevious: function() {
      this.timeLine.goToPrev();
    },

    // Got to next event
    goToNext: function() {
      this.timeLine.goToNext();
    },

    // Zoom In
    zoomIn: function() {
      this.zoom++;
      this.timeLine.setZoom(this.zoom);
    },

    // Zoom Out
    zoomOut: function() {
      this.zoom--;
      this.timeLine.setZoom(this.zoom);
    },

    // CALLED BY OBSERVABLE ON ZOOM
    zoomChanged: function() {

      if (this.zoom === 0) {
        this.$.ZoomOutButton.disabled = true;
      } else {
        this.$.ZoomOutButton.disabled = false;
      }

      if (this.zoom === 10) {
        this.$.ZoomInButton.disabled = true;
      } else {
        this.$.ZoomInButton.disabled = false;
      }
    },

    // Set the ids of the first and last events so we can disable buttons
    setFirstAndLast: function() {
      this.firstEventId = this.timeLineData.events[0].unique_id;
      this.lastEventId = this.timeLineData.events[this.timeLineData.events.length - 1].unique_id;
    },

    // CALLED BY OBSERVABLE ON SELECTEDEVENT
    selectedEventChanged: function() {

      if (this.timeLineData) {

        if (this.selectedEvent === 0 || this.selectedEvent === this.firstEventId) {
          this.$.PreviousButton.disabled = true;
        } else {
          this.$.PreviousButton.disabled = false;
        }

        if (this.selectedEvent === this.lastEventId) {
          this.$.NextButton.disabled = true;
        } else {
          this.$.NextButton.disabled = false;
        }
      }
    },

    // Called when a selected event is changed via Timeline.js
    selectedTimeLineEventChanged: function(eventData) {
      this.selectedEvent = eventData.unique_id;
    },

    // CALLED BY OBSERVABLE ON TIMELINEDATA
    timeLineDataChanged: function() {
      console.log('Timeline data changed');
    }
  });
})();
</script>
