<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="epe-data-grid">
  <style>
    :host {
      display: block;
    }

    iron-list {
      background-color: var(--primary-background-color);
      --iron-list-items-container: {
         border-bottom: 0 none;
       };
    }

    .checkbox-holder {
      vertical-align: middle;
      text-align: center;
      padding: 0;
    }

    paper-checkbox {
      --paper-checkbox-unchecked-background-color: var(--primary-background-color);
    }

    .data-grid__container {
      background-color: var(--primary-background-color);
      border-color: #e6e6e6;
      color: #444;
      font-size: 14px;
      margin-bottom: 15vh;
    }

    .data-grid__footer {
      background-color: var(--text-primary-color);
      border-top: 1px var(--divider-color) solid;
      height: 15vh;
      position: fixed;
      bottom: 0;
      width: 100%;
    }

    .data-grid__header {
      border-bottom-style: solid;
      border-bottom-width: 1px;
      border-bottom-color: #e6e6e6;
    }

    .data-grid__header-wrapper {
      position: relative;
      width: 100%;
      overflow: hidden;
      border-style: solid;
      border-width: 0 1px 0 0;
      border-color: #e6e6e6;
    }

    table {
      margin: 0;
      max-width: none;
      border-collapse: separate;
      border-spacing: 0;
      empty-cells: show;
      border-width: 0;
      outline: 0;
    }

    .data-grid__header-wrapper table {
      margin-bottom: -1px;
    }

    .data-grid__header table {
      table-layout: fixed;
    }

    .checkbox-col {
      width: 50px;
    }

    th {
      background-color: #F3F3F3;
      border-color: #e6e6e6;
      border-left-width: 0;
      color: #a8a8a8;
      border-style: solid;
      border-width: 0 0 1px 1px;
      padding: 0 .6em;
      padding-left: 1.286em;
      font-weight: 400;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: left;
      vertical-align: bottom;
      text-transform: capitalize;
    }

    .field-heading__name {
      display: block;
      padding: 0;
      margin: 0;
      min-height: 16px;
      line-height: inherit;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .field-heading__name span {
      display: inline;
    }

    .list-item {
      border-bottom: 1px var(--divider-color) solid;
      line-height: 3;
      padding: 0 0 0 16px;
    }

    .selected-by-event {
      margin: 0 0 0 8px;
      padding: 0 10px 0 0;
    }

    .selected-by-event__icon {
      color: var(--paper-green-500);
      height: 2.4vh;
      width: 2.4vh;
    }

    .selected-by-event-heading {
      padding: 0;
      margin: 0;
      line-height: 5vh;
      text-align: center;
      vertical-align: middle;
    }

    .selected-by-event__heading-icon {
      height: 2.4vh;
      width: 2.4vh;
    }

    .chevron-holder {
      cursor: pointer;
      line-height: 2.8;
    }

    .chevron {
      color: var(--paper-grey-700);
      transition: transform 200ms cubic-bezier(0.4, 0, 0.2, 1) 200ms, background-color 200ms cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-transition: -webkit-transform 200ms cubic-bezier(0.4, 0, 0.2, 1) 200ms, background-color 200ms cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-transform: rotate(90deg);
      transform: rotate(90deg);
      -webkit-transform-origin: 50% 50%;
      transform-origin: 50% 50%;
    }

    th[sort-status="true"] .chevron {
      -webkit-transform: rotate(180deg);
    }

    th[sort-status="false"] .chevron {
      -webkit-transform: rotate(0);
    }

    .total-records {
      color: var(--secondary-text-color);
      font-size: 1.5vh;
      text-align: center;
    }

    .no-records {
      font-size: 2vh;
    }

    paper-button > iron-icon {
      height: 1.5vw;
      width: 1.5vw;
      margin: 0 0 0 0.8vw;
    }

    @media (min-width: 1020px) {

      paper-button > iron-icon {
        height: 15px;
        width: 15px;
        margin: 0 0 0 8px;
      }
    }

    paper-fab {
      background-color: var(--default-primary-color);
    }

    .blank,
    .field__source {
      width: 8vw;
    }

    .field__button {
      background-color: var(--primary-background-color);
      font-size: 0.8vw;
      line-height: 3;
      padding: 0 0.5vw;
    }

    @media (min-width: 1020px) {

      .field__button {
        font-size: 8px;
      }
    }

  </style>
  <template>

    <div class="data-grid layout vertical">
      <div class="data-grid__container">

        <!-- DataGrid Header -->
        <div class="data-grid__header">
          <div class="data-grid__header-wrapper" data-role="resizeable">

            <table id="HeaderTable">
              <colgroup>
                <col class="checkbox-col">
                <template is="dom-repeat"
                          items="[[toArray(gridDataFirstRecord)]]">
                  <col class="field-col"
                       heading-name$="[[item.name]]"
                       hidden$="[[!showField(item.name)]]">
                </template>
                <thead>
                  <tr>
                    <th id="checkBoxHolder"
                        scope="col"
                        class="checkbox-holder"
                        hidden$="[[!noRecords]]">
                      <paper-checkbox
                        id="SelectAllCheckbox"
                        checked$="[[showAllSelected]]"
                        on-change="selectAllRecords"
                        on-iron-change="selectAllRecords"></paper-checkbox>
                    </th>
                    <template is="dom-repeat"
                              items="[[toArray(gridDataFirstRecord)]]">
                      <th scope="col"
                          class="field-heading"
                          hidden$="[[!showField(item.name)]]"
                          sort-status="neutral"
                          heading-name$="[[item.name]]"
                          on-mouseover="showFullText"
                          on-mouseout="hideFullText"
                          on-tap="sortByColumn">
                        <div class="field-heading__name"
                             on-tap="reOrderColumn">
                          <span>{{item.name}}</span>
                          <span class="chevron-holder">
                            <iron-icon
                              icon="arrow-drop-up"
                              class="chevron"><iron-icon>
                          </span>
                        </div>
                      </th>
                    </template>
                    <th scope="col"
                        class="selected-by-event-heading"
                         hidden$="[[hideRelatedToEventColumn]]">
                      <iron-icon icon="event"
                                 class="selected-by-event__heading-icon"></iron-icon>
                      <paper-tooltip position="top">Item is<br/>related to<br/>a selected <br/>event</paper-tooltip>
                    </th>
                    <th scope="col"
                        class="blank"
                        hidden$="[[hideViewSourceButton]]">
                    </th>
                  </tr>
                </thead>
              </colgroup>
            </table>
          </div>
        </div>

        <!-- DataGrid Fields -->

        <!-- <div class="headings">
          <div class="heading layout horizontal">
            <div id="checkBoxHolder"
                 class="checkbox-holder"
                 hidden$="[[!noRecords]]">
              <paper-checkbox
                id="SelectAllCheckbox"
                checked$="[[showAllSelected]]"
                on-change="selectAllRecords"
                on-iron-change="selectAllRecords"></paper-checkbox>
            </div>
            <paper-tooltip for="checkBoxHolder" position="top">Select All</paper-tooltip>
            <template is="dom-repeat"
                      items="[[toArray(gridDataFirstRecord)]]">
              <div class="field-heading flex layout horizontal"
                   hidden$="[[!showField(item.name)]]"
                   sort-status="neutral"
                   heading-name$="[[item.name]]"
                   on-mouseover="showFullText"
                   on-mouseout="hideFullText"
                   on-tap="sortByColumn">
                <div class="field-heading__text flex">
                  <span>{{item.name}}</span>
                </div>
                <div class="chevron-holder">
                  <iron-icon
                    icon="arrow-drop-up"
                    class="chevron"><iron-icon>
                </div>
              </div>
            </template>
            <div class="selected-by-event-heading flex layout horizontal center center-justified"
                 hidden$="[[hideRelatedToEventColumn]]">
              <iron-icon icon="event"
                         class="selected-by-event__heading-icon"></iron-icon>
              <paper-tooltip position="top">Item is<br/>related to<br/>a selected <br/>event</paper-tooltip>
            </div>
            <div class="blank" hidden$="[[hideViewSourceButton]]"></div>
          </div>
        </div>-->

        <div class="records">
          <template id="ListTemplate"
                    is="dom-repeat"
                    items="[[paginatedData]]">
            <div class="list-item layout horizontal">
              <div class="checkbox-holder">
                <paper-checkbox class="record-checkbox"
                                on-iron-change="selectRecord"
                                on-change="selectRecord"
                                checked$="[[item.showRecord]]"></paper-checkbox>
              </div>
              <template is="dom-repeat" items="[[toArray(item)]]">
                <div class="field flex"
                     on-mouseover="showFullText"
                     on-mouseout="hideFullText"
                     hidden$="[[!showField(item.name)]]">
                  <span>{{item.value}}</span>
                </div>
              </template>
              <div class="selected-by-event field flex layout horizontal center center-justified"
                   hidden$="[[hideRelatedToEventColumn]]">
                <iron-icon icon="check"
                           class="selected-by-event__icon"
                           hidden$="[[!item.highlightAsRelatedToEvent]]"></iron-icon></div>
              <div class="field__source layout horizontal center center-justified"
                   hidden$="[[hideViewSourceButton]]">
                <paper-button
                  class="field__button"
                  raised
                  on-tap="viewSourceFile">View <iron-icon icon="description"></iron-icon>
                </paper-button>
              </div>
            </div>
          </template>
        </div>

        <!-- No records returned form filter -->
        <div hidden$="[[noRecords]]"
             class="no-records fit layout horizontal center center-justified">
          <div>There are no records matching the selected filters.</div>
        </div>

      </div>

      <!-- Footer Bar -->
      <div hidden$="[[!noRecords]]"
           class="data-grid__footer layout horizontal center center-justified">
        <div class="layout vertical">
          <div class="total-records">
            <span>[[totalRecords]]</span> Results
          </div>
          <epe-paginator
            id="Paginator"
            perpage="50"
            items="{{paginatedData}}"
            data="[[gridData]]"
            show-first="true"
            show-last="true"></epe-paginator>
        </div>
      </div>
    </div>

    <!-- Import Notifications -->
    <paper-toast id="ShowFullTextToast" duration="3600000">
      <div>[[fullText]]</div>
    </paper-toast>
  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: 'epe-data-grid',

    properties: {

      collectionName: {
        type: String,
        observer: 'collectionNameChanged'
      },

      gridData: {
        type: Array,
        observer: 'gridDataChanged'
      },

      // Used to get the headings
      gridDataFirstRecord: {
        type: Object,
        value: {}
      },

      // Used to retain sort info on column headers
      sortingState: {
        type: Object,
        observer: 'sortingStateChanged'
      },

      totalRecords: {
        type: Number,
        computed: 'getTotalRecords(gridData)'
      },

      noRecords: {
        type: Boolean,
        computed: 'areThereAnyRecords(gridData)',
        value: false
      },

      hideViewSourceButton: {
        tye: Boolean,
        computed: 'isSource(collectionName)'
      },

      hideRelatedToEventColumn: {
        tye: Boolean,
        computed: 'isEvent(collectionName)'
      },

      fullText: {
        type: String,
        value: ''
      },

      showAllSelected: {
        type: Boolean,
        value: false,
        notify: true
      }
    },

    // Iterate through keys of an object and return key/value pair
    toArray: function(obj) {

      if (obj) {
        return Object.keys(obj).map(function (key) {
          return {
            name: key,
            value: obj[key]
          };
        });
      } else {
        return [];
      }
    },

    // Return false if item is a loki property
    showField: function(keyName) {

      var schemaFieldsToDisplay = [];

      switch (this.collectionName) {
        case app.config.EventsCollection.name:
          app.config.EventsCollection.fields.forEach(function(object) {
            if (object.display === 'true') {
              schemaFieldsToDisplay.push(object.name);
            }
          }.bind(this));
          break;
        case app.config.PlacesCollection.name:
          app.config.PlacesCollection.fields.forEach(function(object) {
            if (object.display === 'true') {
              schemaFieldsToDisplay.push(object.name);
            }
          }.bind(this));
          break;
        case app.config.PeopleCollection.name:
          app.config.PeopleCollection.fields.forEach(function(object) {
            if (object.display === 'true') {
              schemaFieldsToDisplay.push(object.name);
            }
          }.bind(this));
          break;
        case app.config.SourcesCollection.name:
          app.config.SourcesCollection.fields.forEach(function(object) {
            if (object.display === 'true') {
              schemaFieldsToDisplay.push(object.name);
            }
          }.bind(this));
          break;
      }

      if (_.indexOf(schemaFieldsToDisplay, keyName) === -1) {
        return false;
      }

      return true;
    },

    // Return whether there are any records
    areThereAnyRecords: function(gridData) {

      if (gridData) {
        if (gridData.length > 0) {
          return true;
        }
      }
      return false;
    },

    // Return total number of records in the gridData
    getTotalRecords: function(gridData) {

      if (gridData) {
        return gridData.length;
      }
      return 0;
    },

    // CALLED BY OBSERVABLE ON COLLECTIONNAME
    collectionNameChanged: function() {

      // Reset Pagination to first page on collection name changing
      this.$.Paginator.currentpage = 0;
    },

    // CALLED BY OBSERVABLE ON GRIDDATA
    gridDataChanged: function() {

      if (this.gridData) {

        // This is the column headings
        this.gridDataFirstRecord = this.gridData[0];

        // Force template-repeat to show checkboxes in correct state after the
        // show record property has changed
        this.updateCheckboxes();

        // Set table to relevant size depending on widths of heading names
        this.setDefaultTableWidths();
      }
    },

    // Set default table and column widths
    setDefaultTableWidths: function() {

      var fieldHeadings = this.querySelectorAll('.field-heading');

      // Set the colGroup width based on the width of the field heading
      if (fieldHeadings.length > 0) {

        // Set each colGroup col's width
        fieldHeadings.forEach(function(fieldHeading) {

          var headingName = fieldHeading.getAttribute('heading-name');
          var $col;

          if (fieldHeading.clientWidth > 0) {
            $col = this.querySelector('.field-col[heading-name="' + fieldHeading.getAttribute('heading-name') + '"');
            $col.style.width = fieldHeading.clientWidth + 'px';
          }
        }.bind(this));

        // Set width for heading table
        this.$.HeaderTable.style.width = this.$.HeaderTable.clientWidth + 'px';
      }
    },

    // Force template-repeat to show checkboxes in correct state after the
    // show record property has changed
    updateCheckboxes: function() {

      this.gridData.forEach(function(item, index) {

        this.$.ListTemplate.set('items.' + index + '.showRecord', item.showRecord);
      }.bind(this));
    },

    // CALLED BY OBSERVABLE ON SORTINGSTATE
    sortingStateChanged: function() {

      // Stick in async so the gridData headings will have been added to DOM in template
      this.async(this.resetHeadingSortIndicators);
    },

    // Reset all heading sort statuses to neutral
    resetHeadingSortIndicators: function() {

      var selectorName = 'th[heading-name="' + this.sortingState.property + '"]';
      var $sortedHeader = Polymer.dom(this.root).querySelector(selectorName);
      var $headers = Polymer.dom(this.root).querySelectorAll('th');

      if (!$sortedHeader) {
        return;
      }

      // Set any current sorts back to neutral
      $headers.forEach(function($header) {
        $header.setAttribute('sort-status', 'neutral');
      });

      if (this.sortingState.desc === true) {
        $sortedHeader.setAttribute('sort-status', 'false');
      } else if (this.sortingState.desc === false) {
        $sortedHeader.setAttribute('sort-status', 'true');
      }
    },

    // Sort gridData by column
    sortByColumn: function(event) {

      var desc;
      var sortingObject;
      var sortStatus = event.currentTarget.getAttribute('sort-status');

      // Set the desc property to send to the sorting collection transform
      if (sortStatus === 'neutral' || sortStatus === 'false') {
        desc = false;
      } else if (sortStatus === 'true') {
        desc = true;
      }

      sortingObject = {
        collectionName: this.collectionName,
        fieldName: event.model.item.name,
        desc: desc
      };

      // Call sortingChanged action
      this.filterStateActions.sortingChanged(sortingObject);
    },

    // FIRED BY USER SELECTING CHECKBOXHOLDER: Select all checkboxes in list
    selectAllRecords: function(event) {

      if (this.gridData) {

        // Update all items in the data collection
        this.gridData.forEach(function(record, index) {

          if (event.target.checked) {
            this.showAllSelected = true;
            this.$.ListTemplate.set('items.' + index + '.showRecord', true);
          } else {
            this.showAllSelected = false;

            // Only set checkbox to false if user has deselected Select All checkbox not when called programmatically
            if (event.type === 'change') {
              this.$.ListTemplate.set('items.' + index + '.showRecord', false);
            }
          }
        }.bind(this));

        // Call showAllSelected action
        if (event.type === 'change') {
          this.filterStateActions.showAllSelected({
            collectionData: this.gridData,
            collectionName: this.collectionName,
            showAllSelected: this.showAllSelected
          });
        }
      }
    },

    // FIRED BY USER SELECTING A RECORD'S CHECKBOX: Deselect the Select All Checkbox and
    // call filterStateChanged action
    selectRecord: function(event) {

      var checkBoxSelected;

      // Deselect the Select All Checkbox if checkbox is being de-selected
      if (!event.target.checked) {
        checkBoxSelected = false;
        this.showAllSelected = false;

        // Set the model showRecord and highlightAsRelatedToEvent properties
        if(event.model.item) {
          this.$.ListTemplate.set('items.' + event.model.index + '.showRecord', false);
        }
      } else {

        checkBoxSelected = true;

        // Set the model showRecord property
        if(event.model.item) {
          this.$.ListTemplate.set('items.' + event.model.index + '.showRecord', true);

          // Set highlight tick
          if (event.model.item.selectedByEvent) {
           this.$.ListTemplate.set('items.' + event.model.index + '.highlightAsRelatedToEvent', true);
          }
        }
      }

      // Call checkBoxUpdated action
      this.filterStateActions.checkBoxUpdated({
        collectionName: this.collectionName,
        collectionData: this.gridData,
        showAllSelected: this.showAllSelected,
        item: event.model.item,
        checkBoxSelected: checkBoxSelected,
        userSelected: event.type === 'change'
      });
    },

    // FIRED WHEN USER TAPS VIEW SOURCE BUTTON
    viewSourceFile: function(event) {

      var sourceObject = event.model.item;

      // Hack based around need to trigger pdf creation in pdf element so we broadcast a change to null
      // before sending out the object again.
      this.sourceActions.viewSourceFile(null);
      this.sourceActions.viewSourceFile(sourceObject);
    },

    // FIRED WHEN USER TAPS OR MOUSES OVER DATA FIELD
    showFullText: function(event) {

      var dataText;

      // Set text depending on whether method is called from mousing over column heading or data field
      if (event.currentTarget.classList.contains('field-heading')) {
        dataText = event.model.item.name;
      } else {
        dataText = event.model.item.value;
      }

      this.debounce('showFullText', function() {

        // Set toast text
        this.fullText = dataText;

        // Show Toast
        this.$.ShowFullTextToast.show();

        this.cancelDebouncer('showFullText');
      }, 1000);
    },

    // FIRED WHEN USER MOUSES OUT OF DATA FIELD
    hideFullText: function() {

      // Hide toast
      this.$.ShowFullTextToast.hide();

      // Cancel debouncer
      this.cancelDebouncer('showFullText');
    },

    // Computed function to return true if we're looking at a 'Source' data-grid
    isSource: function(collectionName) {

      if (collectionName !== app.config.SourcesCollection.name) {
        return true;
      }
      return false;
    },

    // Computed function to return true if we're looking at a 'Event' data-grid
    isEvent: function() {

      if (this.collectionName === app.config.EventsCollection.name) {
        return true;
      }
      return false;
    }
  });
})();
</script>
